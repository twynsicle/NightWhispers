---
phase: 06-polish-pwa
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vite.config.ts
  - public/pwa-192x192.png
  - public/pwa-512x512.png
  - public/apple-touch-icon.png
  - public/favicon.ico
  - src/lib/pwa.ts
autonomous: true

must_haves:
  truths:
    - "App can be installed to home screen on mobile browsers"
    - "PWA manifest includes correct app name, theme colors, and icons"
    - "Service worker registers automatically on page load"
    - "App displays in standalone mode when launched from home screen"
  artifacts:
    - path: "vite.config.ts"
      provides: "VitePWA plugin configuration"
      contains: "VitePWA"
    - path: "public/pwa-192x192.png"
      provides: "192x192 PWA icon"
    - path: "public/pwa-512x512.png"
      provides: "512x512 PWA icon"
    - path: "public/apple-touch-icon.png"
      provides: "180x180 Apple touch icon"
    - path: "src/lib/pwa.ts"
      provides: "PWA utilities and install detection"
      exports: ["isPWAInstalled", "canSubscribeToPush"]
  key_links:
    - from: "vite.config.ts"
      to: "build output"
      via: "VitePWA plugin generates manifest.webmanifest and sw.js"
      pattern: "VitePWA\\("
---

<objective>
Configure PWA installability for Night Whispers so users can install the app to their home screen.

Purpose: iOS push notifications require PWA installation with `display: standalone`. This is the foundation for push notification support.

Output: vite-plugin-pwa configured, app icons created, service worker generated on build.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-polish-pwa/06-RESEARCH.md

@vite.config.ts
@src/theme.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure vite-plugin-pwa</name>
  <files>vite.config.ts</files>
  <action>
Update vite.config.ts to add VitePWA plugin configuration:

1. Import VitePWA from 'vite-plugin-pwa'
2. Add VitePWA to plugins array with configuration:
   - registerType: 'autoUpdate' (auto-update service worker)
   - includeAssets: ['favicon.ico', 'apple-touch-icon.png']
   - manifest configuration:
     - name: 'Night Whispers'
     - short_name: 'Night Whispers'
     - description: 'Private Storyteller-to-player messaging for Blood on the Clocktower'
     - theme_color: '#1a1b1e' (dark.7 from Mantine)
     - background_color: '#141517' (dark.8)
     - display: 'standalone' (REQUIRED for iOS push)
     - orientation: 'portrait'
     - icons array with 192x192 and 512x512 (including maskable)
   - workbox configuration:
     - globPatterns: ['**/*.{js,css,html,ico,png,svg,woff2}']
     - runtimeCaching for Supabase API with NetworkFirst strategy

Reference: 06-RESEARCH.md Pattern 1 (PWA Configuration)

Important: display: 'standalone' is CRITICAL for iOS push notification support.
  </action>
  <verify>
Run `npm run build` and check that:
- dist/manifest.webmanifest exists
- dist/sw.js exists
- manifest contains correct theme_color and display: standalone
  </verify>
  <done>
VitePWA plugin configured with gothic theme colors, standalone display mode, and Supabase caching.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PWA icons</name>
  <files>public/pwa-192x192.png, public/pwa-512x512.png, public/apple-touch-icon.png, public/favicon.ico</files>
  <action>
Create PWA icon files using a gothic-themed design:

1. Create a simple gothic-themed icon:
   - Dark background (#141517)
   - Crimson accent color (#c92a2a)
   - Simple moon/whisper symbol or "NW" monogram

For this task, use a placeholder approach:
1. Create simple colored square PNG files with correct dimensions using canvas or image generation
2. Sizes needed:
   - pwa-192x192.png (192x192)
   - pwa-512x512.png (512x512)
   - apple-touch-icon.png (180x180)
   - favicon.ico (can be 32x32 or multi-size)

Option: Use a Node.js script to generate placeholder icons with correct colors:
```javascript
// scripts/generate-icons.js
const { createCanvas } = require('canvas');
const fs = require('fs');

function generateIcon(size, filename) {
  const canvas = createCanvas(size, size);
  const ctx = canvas.getContext('2d');

  // Dark background
  ctx.fillStyle = '#141517';
  ctx.fillRect(0, 0, size, size);

  // Crimson circle
  ctx.fillStyle = '#c92a2a';
  ctx.beginPath();
  ctx.arc(size/2, size/2, size * 0.35, 0, Math.PI * 2);
  ctx.fill();

  // Moon crescent (dark cutout)
  ctx.fillStyle = '#141517';
  ctx.beginPath();
  ctx.arc(size/2 + size*0.15, size/2, size * 0.25, 0, Math.PI * 2);
  ctx.fill();

  const buffer = canvas.toBuffer('image/png');
  fs.writeFileSync(filename, buffer);
}
```

Alternatively, use online SVG-to-PNG tool or any image editor.

Place all icons in public/ directory.
  </action>
  <verify>
Verify all icon files exist and have correct sizes:
- `ls -la public/pwa-*.png public/apple-touch-icon.png public/favicon.ico`
- Run `npm run build` and verify no icon warnings
  </verify>
  <done>
All PWA icons created: 192x192, 512x512, 180x180 Apple touch icon, and favicon.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create PWA utilities</name>
  <files>src/lib/pwa.ts</files>
  <action>
Create utility functions for PWA state detection in src/lib/pwa.ts:

```typescript
/**
 * PWA utilities for installation and push subscription detection.
 *
 * iOS Safari only supports push notifications when:
 * 1. App is installed to Home Screen
 * 2. Manifest has display: 'standalone'
 *
 * Reference: 06-RESEARCH.md "Detect PWA Installation State"
 */

/**
 * Check if app is running in standalone PWA mode.
 * Returns true if installed to home screen.
 */
export function isPWAInstalled(): boolean {
  // iOS Safari
  if ('standalone' in navigator && (navigator as Navigator & { standalone?: boolean }).standalone) {
    return true
  }

  // Chrome, Edge, etc.
  if (window.matchMedia('(display-mode: standalone)').matches) {
    return true
  }

  return false
}

/**
 * Check if push notifications can be subscribed.
 * Requires service worker AND PushManager (iOS only in PWA mode).
 */
export function canSubscribeToPush(): boolean {
  return 'serviceWorker' in navigator && 'PushManager' in window
}

/**
 * Check if Notifications API is available.
 */
export function areNotificationsSupported(): boolean {
  return 'Notification' in window
}

/**
 * Get current notification permission state.
 */
export function getNotificationPermission(): NotificationPermission | 'unsupported' {
  if (!areNotificationsSupported()) {
    return 'unsupported'
  }
  return Notification.permission
}
```

This provides the foundation for push notification setup in 06-04.
  </action>
  <verify>
- File exists at src/lib/pwa.ts
- TypeScript compilation succeeds: `npm run type-check`
- Exports are correct: grep for 'export function'
  </verify>
  <done>
PWA utilities created with isPWAInstalled, canSubscribeToPush, areNotificationsSupported, getNotificationPermission exports.
  </done>
</task>

</tasks>

<verification>
1. Build completes without errors: `npm run build`
2. Manifest generated: `cat dist/manifest.webmanifest` shows correct values
3. Service worker generated: `ls dist/sw.js`
4. Icons in place: all 4 icon files exist in public/
5. PWA utilities compile: `npm run type-check` passes
6. Dev server shows install prompt in browser (may require HTTPS for full testing)
</verification>

<success_criteria>
- VitePWA plugin configured with gothic theme colors
- display: 'standalone' set (required for iOS push)
- All PWA icons created (192x192, 512x512, apple-touch-icon, favicon)
- PWA utilities module created with installation detection
- Build generates manifest.webmanifest and sw.js
- UX-04 requirement (PWA installable) partially delivered (full verification needs deployment)
</success_criteria>

<output>
After completion, create `.planning/phases/06-polish-pwa/06-01-SUMMARY.md`
</output>

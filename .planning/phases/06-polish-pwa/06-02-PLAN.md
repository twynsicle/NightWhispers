---
phase: 06-polish-pwa
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useDesktopLayout.ts
  - src/components/StorytellerDashboard.tsx
  - src/components/desktop/SplitPanelLayout.tsx
  - src/components/desktop/PlayerSidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Storyteller on viewport >1024px sees split-panel layout"
    - "Left panel shows player list, right panel shows active conversation"
    - "Mobile viewport (<1024px) shows existing card-based layout"
    - "Clicking player in sidebar opens their conversation in right panel"
  artifacts:
    - path: "src/hooks/useDesktopLayout.ts"
      provides: "Desktop breakpoint detection hook"
      exports: ["useDesktopLayout"]
      min_lines: 15
    - path: "src/components/desktop/SplitPanelLayout.tsx"
      provides: "Split-panel layout container for desktop"
      exports: ["SplitPanelLayout"]
      min_lines: 40
    - path: "src/components/desktop/PlayerSidebar.tsx"
      provides: "Player list sidebar for desktop"
      exports: ["PlayerSidebar"]
      min_lines: 60
    - path: "src/components/StorytellerDashboard.tsx"
      provides: "Updated dashboard with conditional desktop/mobile rendering"
      contains: "useDesktopLayout"
  key_links:
    - from: "src/components/StorytellerDashboard.tsx"
      to: "src/hooks/useDesktopLayout.ts"
      via: "useDesktopLayout() hook call"
      pattern: "useDesktopLayout\\(\\)"
    - from: "src/components/StorytellerDashboard.tsx"
      to: "src/components/desktop/SplitPanelLayout.tsx"
      via: "conditional render when isDesktop"
      pattern: "isDesktop.*SplitPanelLayout"
---

<objective>
Create desktop-optimized split-panel layout for Storyteller dashboard.

Purpose: Desktop users (primarily Storytellers on laptops) benefit from seeing player list and active conversation side-by-side without navigation.

Output: Desktop breakpoint detection, split-panel layout with player sidebar and conversation panel.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-polish-pwa/06-RESEARCH.md

@src/components/StorytellerDashboard.tsx
@src/components/ConversationView.tsx
@src/hooks/useUnreadCount.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create desktop breakpoint hook</name>
  <files>src/hooks/useDesktopLayout.ts</files>
  <action>
Create src/hooks/useDesktopLayout.ts:

```typescript
import { useMediaQuery } from '@mantine/hooks'
import { em } from '@mantine/core'

/**
 * Desktop layout detection hook.
 *
 * Uses 1024px breakpoint per UX-03 requirement.
 * SSR-safe via getInitialValueInEffect option.
 *
 * Reference: 06-RESEARCH.md "Desktop Breakpoint Hook"
 */
export function useDesktopLayout() {
  const isDesktop = useMediaQuery(`(min-width: ${em(1024)})`, false, {
    getInitialValueInEffect: true,  // SSR-safe
  })

  return { isDesktop: isDesktop ?? false }
}
```

The hook:
- Uses Mantine's useMediaQuery (already installed)
- 1024px breakpoint per UX-03 requirement
- SSR-safe (getInitialValueInEffect: true)
- Returns object for future extensibility (could add isTablet, isMobile)
  </action>
  <verify>
- File exists: src/hooks/useDesktopLayout.ts
- TypeScript compiles: `npm run type-check`
- Export exists: grep for 'export function useDesktopLayout'
  </verify>
  <done>
useDesktopLayout hook created with 1024px breakpoint detection.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create desktop layout components</name>
  <files>src/components/desktop/SplitPanelLayout.tsx, src/components/desktop/PlayerSidebar.tsx</files>
  <action>
Create desktop layout components:

**1. src/components/desktop/SplitPanelLayout.tsx:**

```typescript
import { Group, Box } from '@mantine/core'
import type { ReactNode } from 'react'

interface SplitPanelLayoutProps {
  sidebar: ReactNode
  main: ReactNode
  sidebarWidth?: number
}

/**
 * Split-panel layout for desktop Storyteller view.
 *
 * - Left: Player sidebar (fixed width)
 * - Right: Active conversation (flex)
 *
 * Implements DASH-04: Desktop shows split-panel (player list + chat)
 */
export function SplitPanelLayout({
  sidebar,
  main,
  sidebarWidth = 320,
}: SplitPanelLayoutProps) {
  return (
    <Group
      align="stretch"
      gap={0}
      wrap="nowrap"
      style={{
        height: '100vh',
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        backgroundColor: 'var(--mantine-color-dark-8)',
      }}
    >
      {/* Sidebar */}
      <Box
        w={sidebarWidth}
        style={{
          borderRight: '1px solid var(--mantine-color-dark-4)',
          flexShrink: 0,
          overflow: 'hidden',
          display: 'flex',
          flexDirection: 'column',
        }}
      >
        {sidebar}
      </Box>

      {/* Main content */}
      <Box style={{ flex: 1, overflow: 'hidden' }}>
        {main}
      </Box>
    </Group>
  )
}
```

**2. src/components/desktop/PlayerSidebar.tsx:**

```typescript
import { Stack, Text, Card, Group, Badge, ScrollArea, Box } from '@mantine/core'
import { IconRefresh } from '@tabler/icons-react'
import type { Database } from '../../lib/supabase'
import { useUnreadCount } from '../../hooks/useUnreadCount'

type Participant = Database['public']['Tables']['participants']['Row']

interface PlayerSidebarProps {
  roomId: string
  participantId: string
  participants: Participant[]
  selectedPlayerId: string | null
  onSelectPlayer: (player: Participant | null) => void
  onSelectBroadcast: () => void
  isBroadcastSelected: boolean
  onResetGame: () => void
}

/**
 * Player sidebar for desktop Storyteller view.
 *
 * Shows:
 * - Broadcast option at top
 * - Player list with unread badges
 * - Selected state highlighting
 * - Reset game button at bottom
 */
export function PlayerSidebar({
  roomId,
  participantId,
  participants,
  selectedPlayerId,
  onSelectPlayer,
  onSelectBroadcast,
  isBroadcastSelected,
  onResetGame,
}: PlayerSidebarProps) {
  const players = participants.filter(p => p.role !== 'storyteller')

  return (
    <Stack h="100%" gap={0}>
      {/* Header */}
      <Box
        p="md"
        style={{
          borderBottom: '1px solid var(--mantine-color-dark-4)',
          backgroundColor: 'var(--mantine-color-dark-7)',
        }}
      >
        <Text size="lg" fw={700} c="crimson">
          Players
        </Text>
        <Text size="xs" c="dimmed">
          Select to open conversation
        </Text>
      </Box>

      {/* Player list */}
      <ScrollArea style={{ flex: 1 }}>
        <Stack gap={0} p="xs">
          {/* Broadcast option */}
          <SidebarItem
            icon="broadcast"
            name="Broadcast to All"
            subtitle="Send to all players"
            selected={isBroadcastSelected}
            onClick={onSelectBroadcast}
            roomId={roomId}
            participantId={participantId}
            playerId={null}
          />

          {/* Player items */}
          {players.map(player => (
            <SidebarItem
              key={player.id}
              icon={player.avatar_id || undefined}
              name={player.display_name}
              subtitle={player.status === 'dead' ? 'Dead' : undefined}
              customStatus={player.custom_status || undefined}
              selected={selectedPlayerId === player.id}
              onClick={() => onSelectPlayer(player)}
              isDead={player.status === 'dead'}
              roomId={roomId}
              participantId={participantId}
              playerId={player.id}
            />
          ))}
        </Stack>
      </ScrollArea>

      {/* Reset button */}
      <Box
        p="md"
        style={{
          borderTop: '1px solid var(--mantine-color-dark-4)',
        }}
      >
        <Text
          size="sm"
          c="red"
          ta="center"
          style={{ cursor: 'pointer' }}
          onClick={onResetGame}
        >
          <IconRefresh size={14} style={{ verticalAlign: 'middle', marginRight: 4 }} />
          Reset Game
        </Text>
      </Box>
    </Stack>
  )
}

/**
 * Individual sidebar item (player or broadcast).
 */
function SidebarItem({
  icon,
  name,
  subtitle,
  customStatus,
  selected,
  onClick,
  isDead,
  roomId,
  participantId,
  playerId,
}: {
  icon?: string
  name: string
  subtitle?: string
  customStatus?: string
  selected: boolean
  onClick: () => void
  isDead?: boolean
  roomId: string
  participantId: string
  playerId: string | null
}) {
  const unreadCount = useUnreadCount(roomId, participantId, playerId)

  return (
    <Card
      p="sm"
      radius="md"
      onClick={onClick}
      style={{
        cursor: 'pointer',
        backgroundColor: selected
          ? 'var(--mantine-color-dark-5)'
          : 'transparent',
        opacity: isDead ? 0.7 : 1,
      }}
    >
      <Group justify="space-between" gap="sm" wrap="nowrap">
        <Group gap="sm" wrap="nowrap" style={{ overflow: 'hidden' }}>
          <Text
            size="lg"
            style={{
              filter: isDead ? 'grayscale(100%)' : 'none',
              flexShrink: 0,
            }}
          >
            {icon === 'broadcast' ? 'ðŸ“¢' : icon || 'ðŸ‘¤'}
          </Text>
          <Stack gap={2} style={{ overflow: 'hidden' }}>
            <Group gap={4}>
              <Text
                size="sm"
                fw={500}
                style={{
                  overflow: 'hidden',
                  textOverflow: 'ellipsis',
                  whiteSpace: 'nowrap',
                }}
              >
                {name}
              </Text>
              {isDead && <Text size="sm" c="dimmed">ðŸ’€</Text>}
            </Group>
            {subtitle && (
              <Text size="xs" c="dimmed">
                {subtitle}
              </Text>
            )}
            {customStatus && (
              <Badge size="xs" variant="light" color="gray">
                {customStatus}
              </Badge>
            )}
          </Stack>
        </Group>

        {unreadCount > 0 && (
          <Badge color="red" variant="filled" size="sm">
            {unreadCount}
          </Badge>
        )}
      </Group>
    </Card>
  )
}
```
  </action>
  <verify>
- Directory created: src/components/desktop/
- SplitPanelLayout.tsx exists and exports SplitPanelLayout
- PlayerSidebar.tsx exists and exports PlayerSidebar
- TypeScript compiles: `npm run type-check`
  </verify>
  <done>
Desktop layout components created: SplitPanelLayout (container) and PlayerSidebar (player list).
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate desktop layout into StorytellerDashboard</name>
  <files>src/components/StorytellerDashboard.tsx</files>
  <action>
Update StorytellerDashboard.tsx to conditionally render desktop or mobile layout:

1. Import useDesktopLayout hook
2. Import SplitPanelLayout and PlayerSidebar
3. Use useDesktopLayout() to detect desktop viewport
4. When isDesktop:
   - Render SplitPanelLayout with PlayerSidebar and ConversationView
   - Track selectedPlayer state for sidebar selection
   - Keep broadcast mode separate
   - Show placeholder when no conversation selected
5. When mobile (existing behavior):
   - Keep existing SimpleGrid card layout
   - Keep existing navigation to ConversationView

Key changes:
- Add isDesktop check at top of component
- Wrap existing mobile UI in else branch
- Desktop UI uses SplitPanelLayout with sidebar + content
- Desktop shows conversation inline (no full-screen overlay)

Reference: 06-RESEARCH.md Pattern 2 (Desktop Split-Panel Layout)

Important: Desktop ConversationView should NOT have position: fixed - it renders inline in the panel. May need to pass a prop to ConversationView to disable fixed positioning, OR create a simpler inline chat component.

For simplicity, create an inline version:
- Desktop shows messages in right panel without fixed positioning
- Reuse MessageList and MessageInput components directly
  </action>
  <verify>
- StorytellerDashboard imports useDesktopLayout
- Desktop branch renders SplitPanelLayout
- Mobile branch keeps existing SimpleGrid layout
- TypeScript compiles: `npm run type-check`
- Visual test: resize browser window to see layout change at 1024px
  </verify>
  <done>
StorytellerDashboard conditionally renders desktop split-panel or mobile card layout based on viewport width.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npm run type-check` passes
2. Desktop hook works: useDesktopLayout returns { isDesktop: boolean }
3. Desktop components exist in src/components/desktop/
4. StorytellerDashboard uses useDesktopLayout
5. Visual verification:
   - Open app in browser at > 1024px width -> see split-panel
   - Resize to < 1024px -> see card grid
   - Click player in sidebar -> conversation appears in right panel
</verification>

<success_criteria>
- UX-03 delivered: Desktop breakpoint (>1024px) shows optimized layout
- DASH-04 delivered: Desktop shows split-panel (player list + chat)
- Mobile layout unchanged (existing SimpleGrid cards)
- Player selection in sidebar updates right panel
- Broadcast option available in sidebar
</success_criteria>

<output>
After completion, create `.planning/phases/06-polish-pwa/06-02-SUMMARY.md`
</output>

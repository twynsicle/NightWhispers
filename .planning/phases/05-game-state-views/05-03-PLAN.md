---
phase: 05-game-state-views
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/lib/game-reset.ts
  - src/components/GameResetModal.tsx
  - src/components/StorytellerDashboard.tsx
autonomous: true

must_haves:
  truths:
    - "Storyteller can tap 'Reset Game' button to restart game"
    - "Reset confirmation modal prevents accidental resets"
    - "Reset clears all messages from database"
    - "Reset returns phase to 'Night 1'"
    - "Reset keeps all participants in room (no kicked players)"
    - "Reset sets all players to alive status"
    - "All participants see reset in real-time (empty chat, phase reset)"
  artifacts:
    - path: "src/lib/game-reset.ts"
      provides: "Game reset logic with database operations"
      exports: ["resetGame"]
      min_lines: 40
    - path: "src/components/GameResetModal.tsx"
      provides: "Confirmation modal for game reset"
      exports: ["GameResetModal"]
      min_lines: 60
    - path: "src/components/StorytellerDashboard.tsx"
      provides: "Reset button in Storyteller view"
      min_lines: 160
  key_links:
    - from: "src/components/GameResetModal.tsx"
      to: "src/lib/game-reset.ts"
      via: "calls resetGame on confirm"
      pattern: "resetGame\\("
    - from: "src/lib/game-reset.ts"
      to: "messages table"
      via: "DELETE query to clear all room messages"
      pattern: "delete\\(\\).*messages.*room_id"
    - from: "src/lib/game-reset.ts"
      to: "rooms.phase"
      via: "UPDATE query to set phase = 'Night 1'"
      pattern: "update.*rooms.*phase.*Night 1"
    - from: "src/lib/game-reset.ts"
      to: "participants.status"
      via: "UPDATE query to set all participants status = 'alive'"
      pattern: "update.*participants.*status.*alive"
---

<objective>
Enable Storyteller to reset the game while preserving participants.

Purpose: Storyteller may need to restart the game (practice run, false start, rule changes). Reset should clear messages and game state but keep all players in the room to avoid re-joining friction.

Output: Reset button, confirmation modal, and database operations to clear/reset game state.
</objective>

<execution_context>
@C:\Users\kylew\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\kylew\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\workspace\storychat\.planning\PROJECT.md
@C:\workspace\storychat\.planning\ROADMAP.md
@C:\workspace\storychat\.planning\STATE.md

# Database schema for reference
@C:\workspace\storychat\supabase\migrations\001_initial_schema.sql

# Prior summaries for patterns
@C:\workspace\storychat\.planning\phases\04-core-messaging\04-01-SUMMARY.md
@C:\workspace\storychat\.planning\phases\03-lobby-room-management\03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create game reset logic</name>
  <files>
    src/lib/game-reset.ts
  </files>
  <action>
    Create `src/lib/game-reset.ts` that exports:

    **resetGame(roomId: string): Promise&lt;void&gt;**
    - Performs three database operations in sequence using Supabase client:
      1. Delete all messages: `supabase.from('messages').delete().eq('room_id', roomId)`
      2. Reset room phase: `supabase.from('rooms').update({ phase: 'Night 1' }).eq('id', roomId)`
      3. Reset participant status: `supabase.from('participants').update({ status: 'alive', custom_status: null }).eq('room_id', roomId)`
    - Use async/await pattern
    - Error handling: if any operation fails, throw error with descriptive message
    - Success: return void
    - Import supabase client from src/lib/supabase.ts

    **Why this order:**
    - Messages first (most data to clear)
    - Room phase second (resets game state)
    - Participants last (prepares players for new game)

    **Does NOT:**
    - Delete participants (they stay in room)
    - Change room status (stays 'active')
    - Kick anyone (is_active stays true)
    - Change room code or storyteller

    Include JSDoc comments explaining reset behavior.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify TypeScript compiles.
    Verify resetGame exported from game-reset.ts.
    Verify three database operations present in code.
  </verify>
  <done>
    game-reset.ts exists with resetGame function.
    Function deletes messages, resets phase, and resets participant status.
    TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GameResetModal component</name>
  <files>
    src/components/GameResetModal.tsx
  </files>
  <action>
    Create `src/components/GameResetModal.tsx`:
    - Props: `{ roomId: string; opened: boolean; onClose: () => void }`
    - Uses Mantine Modal component
    - Title: "Reset Game?"
    - Body text warning:
      - "This will:"
      - "• Delete all messages"
      - "• Reset phase to Night 1"
      - "• Set all players to alive"
      - "• Keep all participants in the room"
      - Use List component with bullet points
    - Two buttons:
      - Cancel button (secondary, closes modal)
      - Confirm button ("Reset Game", danger color - red variant)
    - On confirm:
      - Calls resetGame(roomId) from src/lib/game-reset.ts
      - Shows loading state (disabled buttons, spinner on confirm button)
      - On success: notification "Game reset successfully", close modal
      - On error: notification with error message, keep modal open
    - Gothic theme styling (dark modal, crimson/red accents)

    Use Mantine notifications for feedback.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify TypeScript compiles.
    Verify GameResetModal exports default component.
    Verify imports resetGame from game-reset.ts.
    Verify Modal with confirm/cancel buttons.
  </verify>
  <done>
    GameResetModal component exists with warning text and confirmation.
    Component calls resetGame on confirm.
    TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate reset button into StorytellerDashboard</name>
  <files>
    src/components/StorytellerDashboard.tsx
  </files>
  <action>
    Update `src/components/StorytellerDashboard.tsx`:

    **Add reset button:**
    - Import GameResetModal component
    - Add state: `const [resetModalOpened, setResetModalOpened] = useState(false)`
    - Add "Reset Game" button in Storyteller view
      - Placement: Below PhaseControls (if visible) or as menu item
      - Use Button component with red/danger color
      - Icon: IconRefresh from @tabler/icons-react
      - onClick opens modal: setResetModalOpened(true)
      - Variant: subtle or outline (less prominent than primary actions)
    - Render GameResetModal at bottom of component:
      - Pass roomId, opened=resetModalOpened, onClose={() => setResetModalOpened(false)}

    **Layout consideration:**
    - Reset is destructive action, should not be prominent
    - Consider placing in overflow menu (three dots) or at bottom of dashboard
    - Not mixed with primary actions (Advance Phase, player cards)
    - Mobile-friendly placement

    Existing real-time subscriptions (useMessages, useParticipants, usePhase) will automatically reflect the reset changes (empty messages, phase = Night 1, status = alive).
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify TypeScript compiles.
    Verify StorytellerDashboard imports GameResetModal.
    Verify reset button renders with modal state.
    Run `npm run dev` to check UI loads.
  </verify>
  <done>
    StorytellerDashboard has "Reset Game" button.
    Button opens GameResetModal on click.
    Modal integration complete with state management.
  </done>
</task>

</tasks>

<verification>
**Automated checks:**
- [ ] TypeScript compiles without errors (`npx tsc --noEmit`)
- [ ] resetGame function exported from game-reset.ts
- [ ] GameResetModal component exists
- [ ] StorytellerDashboard imports GameResetModal
- [ ] Reset button renders in Storyteller view

**Manual verification:**
1. Start game as Storyteller with at least 1 player
2. Send several messages back and forth
3. Advance phase to "Day 2"
4. Mark a player as dead
5. Tap "Reset Game" button in Storyteller view
6. Verify modal appears with warning text
7. Tap "Cancel", verify modal closes without changes
8. Tap "Reset Game" again, then tap "Confirm"
9. Verify notification "Game reset successfully"
10. Verify messages disappear for both Storyteller and Player (empty chat)
11. Verify phase resets to "Night 1" in header for both participants
12. Verify dead player's avatar returns to normal (alive status)
13. Verify both participants still in room (not kicked)
14. Send new message, verify it appears (messaging still works)
</verification>

<success_criteria>
**GAME-06 delivered:** Storyteller can reset game (clears messages, resets phase, keeps players)

Game reset working:
- Confirmation modal prevents accidental resets
- Database operations clear messages and reset state
- Participants remain in room (not kicked)
- Real-time updates propagate reset to all participants
- Phase resets to "Night 1"
- Player status resets to "alive"
</success_criteria>

<output>
After completion, create `.planning/phases/05-game-state-views/05-03-SUMMARY.md`
</output>

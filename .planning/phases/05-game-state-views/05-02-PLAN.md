---
phase: 05-game-state-views
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/usePlayerStatus.ts
  - src/components/PlayerStatusControls.tsx
  - src/components/ParticipantList.tsx
  - src/components/StorytellerDashboard.tsx
autonomous: true

must_haves:
  truths:
    - "Storyteller can toggle player between alive/dead status"
    - "Dead player's avatar appears greyed/faded for all participants"
    - "Storyteller can set custom status text per player (e.g., 'Poisoned', 'Protected')"
    - "Custom status text visible on player card in Storyteller dashboard"
    - "Status updates propagate in real-time (< 1 second)"
  artifacts:
    - path: "src/hooks/usePlayerStatus.ts"
      provides: "Status update helpers for participants table"
      exports: ["usePlayerStatus"]
      min_lines: 30
    - path: "src/components/PlayerStatusControls.tsx"
      provides: "UI for death toggle and custom status input"
      exports: ["PlayerStatusControls"]
      min_lines: 80
    - path: "src/components/ParticipantList.tsx"
      provides: "Updated to grey dead player avatars"
      min_lines: 60
    - path: "src/components/StorytellerDashboard.tsx"
      provides: "Updated PlayerCard to show dead status and custom status preview"
      min_lines: 180
  key_links:
    - from: "src/components/PlayerStatusControls.tsx"
      to: "src/hooks/usePlayerStatus.ts"
      via: "calls toggleDead and setCustomStatus helpers"
      pattern: "toggleDead\\(|setCustomStatus\\("
    - from: "src/components/ParticipantList.tsx"
      to: "participant.status"
      via: "applies greyscale filter when status === 'dead'"
      pattern: "filter.*grayscale|opacity.*0\\.5"
    - from: "src/components/StorytellerDashboard.tsx (PlayerCard)"
      to: "participant.status"
      via: "applies greyscale filter and shows custom_status preview"
      pattern: "filter.*grayscale|custom_status"
    - from: "src/components/StorytellerDashboard.tsx"
      to: "src/components/PlayerStatusControls.tsx"
      via: "renders status controls in player card or conversation view"
      pattern: "<PlayerStatusControls"
---

<objective>
Enable Storyteller to manage player status (alive/dead toggle and custom status text).

Purpose: Game state tracking requires marking players as dead and optionally adding custom status notes (e.g., "Poisoned", "Protected", "Mayor"). Visual feedback helps all participants track game state while custom status aids Storyteller's private record-keeping.

Output: Status management UI, real-time status updates, and visual differentiation for dead players.
</objective>

<execution_context>
@C:\Users\kylew\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\kylew\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\workspace\storychat\.planning\PROJECT.md
@C:\workspace\storychat\.planning\ROADMAP.md
@C:\workspace\storychat\.planning\STATE.md

# Database schema has participants.status and participants.custom_status
@C:\workspace\storychat\supabase\migrations\001_initial_schema.sql

# ParticipantList component for reference
@C:\workspace\storychat\src\components\ParticipantList.tsx

# StorytellerDashboard for integration point
@C:\workspace\storychat\.planning\phases\04-core-messaging\04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create usePlayerStatus hook for status management</name>
  <files>
    src/hooks/usePlayerStatus.ts
  </files>
  <action>
    Create `src/hooks/usePlayerStatus.ts` that:
    - Exports `toggleDead(participantId: string)` helper
      - Fetches current participant.status from database
      - Toggles between 'alive' and 'dead'
      - Updates participants table with new status
      - Returns updated status or throws error
    - Exports `setCustomStatus(participantId: string, customStatus: string | null)` helper
      - Updates participants.custom_status column
      - NULL clears custom status
      - Returns success or throws error
    - Both helpers use Supabase client from src/lib/supabase.ts
    - Error handling with try/catch, returns error messages
    - Uses async/await pattern

    Pattern matches existing room utilities (src/lib/rooms.ts).
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify TypeScript compiles.
    Verify toggleDead and setCustomStatus exported from usePlayerStatus.ts.
  </verify>
  <done>
    usePlayerStatus.ts exists with toggleDead and setCustomStatus helpers.
    TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PlayerStatusControls component</name>
  <files>
    src/components/PlayerStatusControls.tsx
  </files>
  <action>
    Create `src/components/PlayerStatusControls.tsx`:
    - Props: `{ participant: Participant }` (from Database types)
    - Imports toggleDead and setCustomStatus from usePlayerStatus hook
    - Renders two sections: Death Toggle + Custom Status Input

    **Death Toggle:**
    - Switch component (Mantine) labeled "Mark as Dead"
    - Checked state reflects participant.status === 'dead'
    - onChange calls toggleDead(participant.id)
    - Shows loading state while updating (disabled switch)
    - Notification on success ("Player marked as dead/alive")
    - Error handling with notification on failure

    **Custom Status Input:**
    - TextInput (Mantine) for custom status text
    - Placeholder: "e.g., Poisoned, Protected, Mayor"
    - Value controlled by local state, initialized with participant.custom_status
    - Debounced update (1 second) to avoid excessive writes
    - Uses Mantine useDebouncedValue hook
    - useEffect watches debounced value, calls setCustomStatus when changed
    - Button to clear custom status (sets to null)
    - Character limit: 50 chars

    **Layout:**
    - Stack layout for vertical arrangement
    - Gothic theme styling (crimson accents, dark backgrounds)
    - Compact size for mobile

    Use Mantine notifications for feedback.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify TypeScript compiles.
    Verify PlayerStatusControls exports default component.
    Verify imports toggleDead and setCustomStatus.
  </verify>
  <done>
    PlayerStatusControls component exists with death toggle and custom status input.
    Component uses debounced updates for text input.
    TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update ParticipantList and StorytellerDashboard to show dead/custom status</name>
  <files>
    src/components/ParticipantList.tsx
    src/components/StorytellerDashboard.tsx
  </files>
  <action>
    Update `src/components/ParticipantList.tsx`:
    - Apply visual styling for dead players
    - When participant.status === 'dead':
      - Apply CSS filter: `grayscale(100%)` to avatar
      - Reduce opacity to 0.6
      - Add skull emoji (ðŸ’€) next to name or as badge
    - Use Mantine sx prop for conditional styling
    - Maintain existing participant list functionality (names, avatars, role badges)

    Update `src/components/StorytellerDashboard.tsx`:

    **Update PlayerCard component (lines 166-211):**
    - Apply same dead player styling as ParticipantList:
      - When player.status === 'dead', apply grayscale filter and reduced opacity to avatar
      - Add skull emoji (ðŸ’€) badge or indicator
    - Show custom status preview below player name:
      - If player.custom_status exists, render it in small text with badge or subtle styling
      - Example: "Poisoned" badge below "Player" role text
      - Use Mantine Badge or Text component with muted color
    - Maintain existing unread count functionality

    **Add status controls to ConversationView:**
    - Import PlayerStatusControls component
    - Add status controls to ConversationView (when chat with player is open)
    - Render PlayerStatusControls above MessageList in ConversationView
      - Only for 1-to-1 chats (not broadcast mode)
      - Pass selectedParticipant as participant prop
    - Use Paper or Card component to contain status controls
    - Ensure mobile-friendly layout

    Real-time updates: Existing useParticipants hook already subscribes to postgres_changes on participants table, so status updates will automatically propagate when participant.status or participant.custom_status changes.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify TypeScript compiles.
    Verify ParticipantList applies grayscale and opacity to dead players.
    Verify StorytellerDashboard PlayerCard shows dead styling and custom status preview.
    Verify StorytellerDashboard imports and renders PlayerStatusControls.
    Run `npm run dev` to check UI loads.
  </verify>
  <done>
    ParticipantList greys avatars for dead players with skull indicator.
    PlayerCard in StorytellerDashboard shows dead styling and custom status preview.
    StorytellerDashboard shows PlayerStatusControls in conversation view.
    Real-time status updates propagate via existing postgres_changes subscription.
  </done>
</task>

</tasks>

<verification>
**Automated checks:**
- [ ] TypeScript compiles without errors (`npx tsc --noEmit`)
- [ ] usePlayerStatus exports toggleDead and setCustomStatus
- [ ] PlayerStatusControls component exists
- [ ] ParticipantList applies styling for dead players
- [ ] StorytellerDashboard PlayerCard shows custom status preview
- [ ] StorytellerDashboard renders PlayerStatusControls

**Manual verification:**
1. Start game as Storyteller with at least 1 player
2. Verify player cards in dashboard show normal styling (alive)
3. Open conversation with a player
4. Verify "Mark as Dead" switch appears above chat
5. Toggle switch to mark player as dead
6. Verify player's avatar greys out in participant list for both Storyteller and Player
7. Verify player card in Storyteller dashboard also shows greyed avatar
8. Verify skull emoji (ðŸ’€) appears next to dead player's name
9. Enter custom status text "Poisoned" in input field
10. Wait 1 second (debounce)
11. Verify custom status appears as badge on player card in Storyteller dashboard
12. Refresh browser, verify status persists
13. Toggle switch back to alive, verify grey effect removes
</verification>

<success_criteria>
**GAME-04 delivered:** Storyteller can toggle player as dead (greys avatar)
**GAME-05 delivered:** Storyteller can set custom status text per player
**DASH-01 delivered:** Player cards show status (dead/alive visual)
**DASH-02 delivered:** Player cards show custom status preview

Status management working:
- Death toggle updates participant.status in real-time
- Visual differentiation for dead players (greyscale, opacity, skull emoji)
- Custom status text updates with debouncing
- Custom status preview on player cards
- Real-time propagation via postgres_changes
- Storyteller-only controls
</success_criteria>

<output>
After completion, create `.planning/phases/05-game-state-views/05-02-SUMMARY.md`
</output>

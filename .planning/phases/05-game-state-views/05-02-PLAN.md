---
phase: 05-game-state-views
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/usePlayerStatus.ts
  - src/components/PlayerStatusControls.tsx
  - src/components/ParticipantList.tsx
  - src/components/StorytellerDashboard.tsx
  - src/components/ConversationView.tsx
autonomous: false

must_haves:
  truths:
    - "Storyteller can toggle player between alive/dead status"
    - "Dead player's avatar appears greyed/faded for all participants"
    - "Storyteller can set custom status text per player (e.g., 'Poisoned', 'Protected')"
    - "Custom status displays as badge below player name on player card"
    - "Status updates propagate in real-time (< 1 second)"
  artifacts:
    - path: "src/hooks/usePlayerStatus.ts"
      provides: "Status update helpers for participants table"
      exports: ["usePlayerStatus"]
      min_lines: 30
    - path: "src/components/PlayerStatusControls.tsx"
      provides: "UI for death toggle and custom status input"
      exports: ["PlayerStatusControls"]
      min_lines: 80
    - path: "src/components/ParticipantList.tsx"
      provides: "Updated to grey dead player avatars"
      min_lines: 60
    - path: "src/components/StorytellerDashboard.tsx"
      provides: "Updated PlayerCard to show dead status and custom status badge"
      min_lines: 180
    - path: "src/components/ConversationView.tsx"
      provides: "Integrates PlayerStatusControls for 1-to-1 chats"
      min_lines: 110
  key_links:
    - from: "src/components/PlayerStatusControls.tsx"
      to: "src/hooks/usePlayerStatus.ts"
      via: "calls toggleDead and setCustomStatus helpers"
      pattern: "toggleDead\\(|setCustomStatus\\("
    - from: "src/components/ParticipantList.tsx"
      to: "participant.status"
      via: "applies greyscale filter when status === 'dead'"
      pattern: "filter.*grayscale|opacity.*0\\.5"
    - from: "src/components/StorytellerDashboard.tsx (PlayerCard)"
      to: "participant.status"
      via: "applies greyscale filter and shows custom_status badge"
      pattern: "filter.*grayscale|custom_status"
    - from: "src/components/ConversationView.tsx"
      to: "src/components/PlayerStatusControls.tsx"
      via: "renders status controls in 1-to-1 chat view"
      pattern: "<PlayerStatusControls"
---

<objective>
Enable Storyteller to manage player status (alive/dead toggle and custom status text).

Purpose: Game state tracking requires marking players as dead and optionally adding custom status notes (e.g., "Poisoned", "Protected", "Mayor"). Visual feedback helps all participants track game state while custom status aids Storyteller's private record-keeping.

Output: Status management UI, real-time status updates, and visual differentiation for dead players.
</objective>

<execution_context>
@C:\Users\kylew\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\kylew\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\workspace\storychat\.planning\PROJECT.md
@C:\workspace\storychat\.planning\ROADMAP.md
@C:\workspace\storychat\.planning\STATE.md

# Database schema has participants.status and participants.custom_status
@C:\workspace\storychat\supabase\migrations\001_initial_schema.sql

# ParticipantList component for reference
@C:\workspace\storychat\src\components\ParticipantList.tsx

# StorytellerDashboard for integration point
@C:\workspace\storychat\.planning\phases\04-core-messaging\04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create usePlayerStatus hook for status management</name>
  <files>
    src/hooks/usePlayerStatus.ts
  </files>
  <action>
    Create `src/hooks/usePlayerStatus.ts` that:
    - Exports `toggleDead(participantId: string)` helper
      - Fetches current participant.status from database
      - Toggles between 'alive' and 'dead'
      - Updates participants table with new status
      - Returns updated status or throws error
    - Exports `setCustomStatus(participantId: string, customStatus: string | null)` helper
      - Updates participants.custom_status column
      - NULL clears custom status
      - Returns success or throws error
    - Both helpers use Supabase client from src/lib/supabase.ts
    - Error handling with try/catch, returns error messages
    - Uses async/await pattern

    Pattern matches existing room utilities (src/lib/rooms.ts).
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify TypeScript compiles.
    Verify toggleDead and setCustomStatus exported from usePlayerStatus.ts.
  </verify>
  <done>
    usePlayerStatus.ts exists with toggleDead and setCustomStatus helpers.
    TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PlayerStatusControls component</name>
  <files>
    src/components/PlayerStatusControls.tsx
  </files>
  <action>
    Create `src/components/PlayerStatusControls.tsx`:
    - Props: `{ participant: Participant }` (from Database types)
    - Imports toggleDead and setCustomStatus from usePlayerStatus hook
    - Renders two sections: Death Toggle + Custom Status Input

    **Death Toggle:**
    - Switch component (Mantine) labeled "Mark as Dead"
    - Checked state reflects participant.status === 'dead'
    - onChange calls toggleDead(participant.id)
    - Shows loading state while updating (disabled switch)
    - Notification on success ("Player marked as dead/alive")
    - Error handling with notification on failure

    **Custom Status Input:**
    - TextInput (Mantine) for custom status text
    - Placeholder: "e.g., Poisoned, Protected, Mayor"
    - Value controlled by local state, initialized with participant.custom_status
    - Debounced update (1 second) to avoid excessive writes
    - Uses Mantine useDebouncedValue hook
    - useEffect watches debounced value, calls setCustomStatus when changed
    - Button to clear custom status (sets to null)
    - Character limit: 50 chars

    **Layout:**
    - Stack layout for vertical arrangement
    - Gothic theme styling (crimson accents, dark backgrounds)
    - Compact size for mobile

    Use Mantine notifications for feedback.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify TypeScript compiles.
    Verify PlayerStatusControls exports default component.
    Verify imports toggleDead and setCustomStatus.
  </verify>
  <done>
    PlayerStatusControls component exists with death toggle and custom status input.
    Component uses debounced updates for text input.
    TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 3a: Update ParticipantList to show dead player styling</name>
  <files>
    src/components/ParticipantList.tsx
  </files>
  <action>
    Update `src/components/ParticipantList.tsx`:
    - Apply visual styling for dead players
    - When participant.status === 'dead':
      - Apply CSS filter: `grayscale(100%)` to avatar
      - Reduce opacity to 0.6
      - Add skull emoji (ðŸ’€) next to name or as badge
    - Use Mantine sx prop for conditional styling
    - Maintain existing participant list functionality (names, avatars, role badges)
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify TypeScript compiles.
    Verify ParticipantList applies grayscale and opacity to dead players.
    Run `npm run dev` to check UI loads.
  </verify>
  <done>
    ParticipantList greys avatars for dead players with skull indicator.
    TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 3b: Update StorytellerDashboard PlayerCard to show dead and custom status</name>
  <files>
    src/components/StorytellerDashboard.tsx
  </files>
  <action>
    Update `src/components/StorytellerDashboard.tsx`:

    **Update PlayerCard component (lines 166-211):**
    - Apply same dead player styling as ParticipantList:
      - When player.status === 'dead', apply grayscale filter and reduced opacity to avatar
      - Add skull emoji (ðŸ’€) badge or indicator next to player name
    - Show custom status badge below player name:
      - If player.custom_status exists, render it as Badge below "Player" role text
      - Use Mantine Badge component with subtle color (gray or default variant)
      - Example: <Badge size="xs" variant="light">{player.custom_status}</Badge>
      - Position between role text and unread badge
    - Maintain existing unread count functionality

    Real-time updates: Existing useParticipants hook already subscribes to postgres_changes on participants table, so status updates will automatically propagate when participant.status or participant.custom_status changes.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify TypeScript compiles.
    Verify StorytellerDashboard PlayerCard shows dead styling and custom status badge.
    Run `npm run dev` to check UI loads.
  </verify>
  <done>
    PlayerCard in StorytellerDashboard shows dead styling (greyscale + skull).
    PlayerCard shows custom status as badge below player name.
    Real-time status updates propagate via existing postgres_changes subscription.
  </done>
</task>

<task type="auto">
  <name>Task 3c: Integrate PlayerStatusControls into ConversationView</name>
  <files>
    src/components/ConversationView.tsx
  </files>
  <action>
    Update `src/components/ConversationView.tsx`:

    **Add status controls to 1-to-1 chats:**
    - Import PlayerStatusControls component
    - Add PlayerStatusControls above MessageList when in 1-to-1 chat mode (recipientId !== null)
    - Do NOT render for broadcast mode (recipientId === null)
    - Find participant from participants array using recipientId:
      ```typescript
      const recipient = participants.find(p => p.id === recipientId)
      ```
    - Pass participant object to PlayerStatusControls as prop
    - Wrap in Paper or Card component with padding for visual separation
    - Ensure mobile-friendly layout (full width, compact spacing)

    **Note on roomId:** ConversationView already receives roomId as a prop (line 10 in current implementation), so no changes needed to prop interface. The participants array is also already passed as a prop (line 15).

    **Layout structure:**
    - Header (existing)
    - PlayerStatusControls (NEW - only for 1-to-1 chats)
    - MessageList (existing)
    - MessageInput (existing)

    PlayerStatusControls receives participant object that includes status and custom_status fields.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify TypeScript compiles.
    Verify ConversationView imports and renders PlayerStatusControls.
    Verify controls only render for 1-to-1 chats (not broadcast).
    Verify participant is found from participants array using recipientId.
    Run `npm run dev` to check UI loads.
  </verify>
  <done>
    ConversationView shows PlayerStatusControls in 1-to-1 chat mode.
    Controls do not appear in broadcast mode.
    Participant object correctly found from participants array.
    TypeScript compiles without errors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Verified that Phase 4 already implements DASH-01, DASH-02, DASH-03 requirements (Storyteller player cards with tap-to-expand and full chat view).

    Verified that Phase 4 already implements PLAY-01, PLAY-02 requirements (Player isolation - only sees Storyteller chat, no access to other players).
  </what-built>
  <how-to-verify>
    **DASH-01/02/03 Verification (Storyteller View):**
    1. Start game as Storyteller with at least 2 players
    2. Verify DASH-01: All players appear as cards on mobile (SimpleGrid with 1 col on mobile, 2 on desktop)
    3. Tap a player card
    4. Verify DASH-02: Card expands to ConversationView showing recent messages with MessageInput for quick send
    5. Send a message in ConversationView
    6. Verify DASH-03: Full chat view is open and functional (MessageList + MessageInput)
    7. Tap back button, verify return to player cards dashboard

    **PLAY-01/02 Verification (Player View):**
    1. Open game as Player (different browser/incognito)
    2. Verify PLAY-01: Player sees only private chat with Storyteller (PlayerChatView component)
    3. Verify PLAY-02: No UI for other players (no participant list, no player selection, only Storyteller conversation)
    4. Send message to Storyteller, verify it appears in Storyteller's conversation view
    5. Verify player cannot access any other conversations (no navigation to other players)

    **Expected Results:**
    - DASH-01: Player cards grid renders with all players
    - DASH-02: Tapping card opens conversation with recent messages and send input
    - DASH-03: Full chat view (ConversationView) is functional
    - PLAY-01: Player sees only Storyteller chat (full screen)
    - PLAY-02: No access to other players (UI enforces isolation)
  </how-to-verify>
  <resume-signal>
    Type "verified" if all requirements pass, or describe specific failures.
  </resume-signal>
</task>

</tasks>

<verification>
**Automated checks:**
- [ ] TypeScript compiles without errors (`npx tsc --noEmit`)
- [ ] usePlayerStatus exports toggleDead and setCustomStatus
- [ ] PlayerStatusControls component exists
- [ ] ParticipantList applies styling for dead players
- [ ] StorytellerDashboard PlayerCard shows custom status badge
- [ ] ConversationView imports and renders PlayerStatusControls

**Manual verification:**
1. Start game as Storyteller with at least 1 player
2. Verify player cards in dashboard show normal styling (alive)
3. Open conversation with a player
4. Verify "Mark as Dead" switch appears above chat
5. Toggle switch to mark player as dead
6. Verify player's avatar greys out in participant list for both Storyteller and Player
7. Verify player card in Storyteller dashboard also shows greyed avatar with skull
8. Verify skull emoji (ðŸ’€) appears next to dead player's name
9. Enter custom status text "Poisoned" in input field
10. Wait 1 second (debounce)
11. Verify custom status appears as badge on player card in Storyteller dashboard
12. Refresh browser, verify status persists
13. Toggle switch back to alive, verify grey effect removes
</verification>

<success_criteria>
**GAME-04 delivered:** Storyteller can toggle player as dead (greys avatar)
**GAME-05 delivered:** Storyteller can set custom status text per player
**DASH-01 verified:** Storyteller sees all players as cards on mobile (already implemented in Phase 4)
**DASH-02 verified:** Tapping player card expands to show recent messages + quick send (already implemented in Phase 4)
**DASH-03 verified:** Storyteller can open full chat view with player (already implemented in Phase 4)
**PLAY-01 verified:** Player sees private chat with Storyteller only (already implemented in Phase 4)
**PLAY-02 verified:** Player cannot see or message other players (already implemented in Phase 4)

Status management working:
- Death toggle updates participant.status in real-time
- Visual differentiation for dead players (greyscale, opacity, skull emoji)
- Custom status text updates with debouncing
- Custom status preview as badge on player cards
- Real-time propagation via postgres_changes
- Storyteller-only controls
</success_criteria>

<output>
After completion, create `.planning/phases/05-game-state-views/05-02-SUMMARY.md`
</output>

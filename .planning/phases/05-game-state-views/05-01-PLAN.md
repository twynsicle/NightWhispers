---
phase: 05-game-state-views
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/phase-helpers.ts
  - src/hooks/usePhase.ts
  - src/components/PhaseHeader.tsx
  - src/components/PhaseControls.tsx
  - src/pages/RoomPage.tsx
autonomous: true

must_haves:
  truths:
    - "All participants see current phase in header (e.g., 'Night 1', 'Day 2')"
    - "Storyteller can tap 'Advance Phase' button to increment phase"
    - "Phase updates propagate to all participants in real-time (< 1 second)"
    - "Phase persists across browser refresh"
  artifacts:
    - path: "src/hooks/usePhase.ts"
      provides: "Real-time phase subscription and update helper"
      exports: ["usePhase"]
      min_lines: 40
    - path: "src/components/PhaseHeader.tsx"
      provides: "Phase display component for all participants"
      exports: ["PhaseHeader"]
      min_lines: 30
    - path: "src/components/PhaseControls.tsx"
      provides: "Storyteller-only phase advancement controls"
      exports: ["PhaseControls"]
      min_lines: 50
    - path: "src/lib/phase-helpers.ts"
      provides: "Phase logic utility (getNextPhase function)"
      exports: ["getNextPhase"]
      min_lines: 20
  key_links:
    - from: "src/pages/RoomPage.tsx"
      to: "src/components/PhaseHeader.tsx"
      via: "renders PhaseHeader for all participants"
      pattern: "<PhaseHeader.*roomId"
    - from: "src/components/PhaseControls.tsx"
      to: "src/hooks/usePhase.ts"
      via: "calls advancePhase helper from usePhase hook"
      pattern: "advancePhase\\("
    - from: "src/hooks/usePhase.ts"
      to: "rooms.phase"
      via: "postgres_changes subscription on phase column"
      pattern: "postgres_changes.*rooms.*UPDATE"
---

<objective>
Enable phase management so all participants see current phase and Storyteller can advance it.

Purpose: Game phases (Night 1, Day 1, Night 2, etc.) structure the game flow and inform participants what stage they're in. Storyteller controls phase progression while all participants stay synchronized.

Output: Phase display header, Storyteller phase controls, and real-time phase synchronization.
</objective>

<execution_context>
@C:\Users\kylew\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\kylew\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\workspace\storychat\.planning\PROJECT.md
@C:\workspace\storychat\.planning\ROADMAP.md
@C:\workspace\storychat\.planning\STATE.md

# Database schema already has rooms.phase column
@C:\workspace\storychat\supabase\migrations\001_initial_schema.sql

# Prior phase summaries for patterns
@C:\workspace\storychat\.planning\phases\04-core-messaging\04-02-SUMMARY.md
@C:\workspace\storychat\.planning\phases\03-lobby-room-management\03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create usePhase hook for real-time phase tracking</name>
  <files>
    src/hooks/usePhase.ts
    src/lib/phase-helpers.ts
  </files>
  <action>
    Create `src/lib/phase-helpers.ts` (game logic utility):
    - Export function `getNextPhase(currentPhase: string): string` that parses "Night X" or "Day X" and returns next phase
    - Logic: "Night 1" ‚Üí "Day 1", "Day 1" ‚Üí "Night 2", "Night 2" ‚Üí "Day 2", etc.
    - Uses regex to parse phase type (Night/Day) and number
    - Returns formatted next phase string

    Create `src/hooks/usePhase.ts` that:
    - Takes roomId parameter
    - Returns { phase, loading, advancePhase }
    - Uses useState for phase and loading state
    - Fetches initial phase from rooms table on mount
    - Subscribes to postgres_changes on rooms table for UPDATE events
    - Updates local state when phase column changes
    - Provides advancePhase helper that increments phase (e.g., "Night 1" ‚Üí "Day 1" ‚Üí "Night 2")
    - advancePhase implementation:
      - Calls getNextPhase from phase-helpers.ts to compute next phase
      - Uses UPDATE query to rooms table: `supabase.from('rooms').update({ phase: newPhase }).eq('id', roomId)`
      - Error handling: catches errors from UPDATE query, returns error state or throws for caller to handle
      - Shows notification on error: "Failed to advance phase. Please try again."
    - Cleans up subscription on unmount

    Pattern matches useParticipants hook (postgres_changes subscription, state management).
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify TypeScript compiles.
    Verify usePhase hook exports phase, loading, advancePhase.
    Verify getNextPhase exported from phase-helpers.ts.
    Verify advancePhase includes error handling for UPDATE query failure.
  </verify>
  <done>
    usePhase hook exists with postgres_changes subscription on rooms.phase.
    getNextPhase helper correctly increments Night/Day phases.
    advancePhase includes try/catch error handling with notification.
    TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PhaseHeader and PhaseControls components</name>
  <files>
    src/components/PhaseHeader.tsx
    src/components/PhaseControls.tsx
  </files>
  <action>
    Create `src/components/PhaseHeader.tsx`:
    - Props: `{ roomId: string }`
    - Uses usePhase hook to get current phase
    - Renders phase in gothic-themed header (crimson text, dark background)
    - Use Mantine Title component (size h3 or h4 for mobile)
    - Center-aligned text
    - Shows loading skeleton while phase loads
    - Include moon/sun icon based on Night/Day (üåô for Night, ‚òÄÔ∏è for Day)

    Create `src/components/PhaseControls.tsx`:
    - Props: `{ roomId: string }`
    - Uses usePhase hook to get advancePhase function
    - Renders "Advance Phase" button (Mantine Button, crimson variant)
    - onClick calls advancePhase
    - Shows loading state while updating (disabled button with spinner)
    - Includes notification on success ("Phase advanced to [newPhase]")
    - Error handling with notification on failure (already handled in usePhase hook)
    - Storyteller-only component (only rendered in Storyteller view)

    Use Mantine notifications for success/error feedback.
    Follow established gothic theme (crimson primary, dark background).
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify TypeScript compiles.
    Verify PhaseHeader renders phase with icon.
    Verify PhaseControls has advance button with loading state.
  </verify>
  <done>
    PhaseHeader component displays current phase with Night/Day icon.
    PhaseControls component has working Advance Phase button.
    Components follow gothic theme and Mantine patterns.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate phase components into RoomPage</name>
  <files>
    src/pages/RoomPage.tsx
  </files>
  <action>
    Update `src/pages/RoomPage.tsx`:

    **For active game status (both Player and Storyteller):**
    - Add PhaseHeader at top of active game view (above PlayerChatView / StorytellerDashboard)
    - Import PhaseHeader and PhaseControls components
    - Wrap phase header in Stack or Box for consistent spacing

    **For Storyteller active view only:**
    - Add PhaseControls below PhaseHeader (above StorytellerDashboard)
    - Use Stack to vertically arrange: PhaseHeader ‚Üí PhaseControls ‚Üí StorytellerDashboard

    **For Player active view:**
    - Only render PhaseHeader (no controls)
    - Use Stack to vertically arrange: PhaseHeader ‚Üí PlayerChatView

    Ensure roomId prop passed to both PhaseHeader and PhaseControls.
    Maintain existing lobby and ended views (no changes).
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify TypeScript compiles.
    Verify PhaseHeader imported and rendered for active status.
    Verify PhaseControls only rendered for Storyteller role.
    Run `npm run dev` and navigate to active game to check UI loads.
  </verify>
  <done>
    RoomPage renders PhaseHeader for all participants in active game.
    RoomPage renders PhaseControls only for Storyteller in active game.
    Layout maintains mobile-first gothic theme.
  </done>
</task>

</tasks>

<verification>
**Automated checks:**
- [ ] TypeScript compiles without errors (`npx tsc --noEmit`)
- [ ] usePhase hook exports phase, loading, advancePhase
- [ ] getNextPhase helper exists in phase-helpers.ts
- [ ] PhaseHeader component exists and imports usePhase
- [ ] PhaseControls component exists with advance button
- [ ] RoomPage imports and renders both components

**Manual verification:**
1. Start a game (Storyteller + at least 1 player)
2. Verify both participants see "Night 1" header at top of screen
3. Storyteller taps "Advance Phase" button
4. Verify phase changes to "Day 1" for both participants in < 1 second
5. Refresh browser (both participants)
6. Verify phase persists as "Day 1"
7. Storyteller advances to "Night 2", verify both see update
8. Verify Player does NOT see "Advance Phase" button
</verification>

<success_criteria>
**GAME-02 delivered:** Current phase displays to all participants
**GAME-03 delivered:** Storyteller can advance phase manually

Phase system working:
- Real-time synchronization via postgres_changes
- Phase persistence in database
- Storyteller-only controls
- All participants see updates
</success_criteria>

<output>
After completion, create `.planning/phases/05-game-state-views/05-01-SUMMARY.md`
</output>

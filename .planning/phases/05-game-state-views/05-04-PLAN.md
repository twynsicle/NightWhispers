---
phase: 05-game-state-views
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/PlayerSettingsMenu.tsx
  - src/lib/leave-room.ts
  - src/components/PlayerChatView.tsx
autonomous: true

must_haves:
  truths:
    - "Player can access settings menu from game view"
    - "Settings menu shows room code for sharing"
    - "Player can tap 'Leave Game' button to exit room"
    - "Leave confirmation modal prevents accidental exits"
    - "Leaving game soft-deletes participant (is_active = false)"
    - "Player redirects to home page after leaving"
  artifacts:
    - path: "src/components/PlayerSettingsMenu.tsx"
      provides: "Settings modal/menu for player with room code and leave button"
      exports: ["PlayerSettingsMenu"]
      min_lines: 80
    - path: "src/lib/leave-room.ts"
      provides: "Leave room logic with soft delete"
      exports: ["leaveRoom"]
      min_lines: 20
    - path: "src/components/PlayerChatView.tsx"
      provides: "Updated to include settings menu button"
      min_lines: 100
  key_links:
    - from: "src/components/PlayerSettingsMenu.tsx"
      to: "src/lib/leave-room.ts"
      via: "calls leaveRoom on confirm"
      pattern: "leaveRoom\\("
    - from: "src/lib/leave-room.ts"
      to: "participants.is_active"
      via: "UPDATE query to set is_active = false"
      pattern: "update.*participants.*is_active.*false"
    - from: "src/components/PlayerChatView.tsx"
      to: "src/components/PlayerSettingsMenu.tsx"
      via: "renders settings button that opens menu"
      pattern: "<PlayerSettingsMenu|setSettingsOpened"
---

<objective>
Enable players to view room code and leave the game.

Purpose: Players need access to room code for sharing with others and ability to leave the room gracefully. Settings menu provides non-intrusive access to these secondary actions.

Output: Player settings menu with room code display and leave game functionality.
</objective>

<execution_context>
@C:\Users\kylew\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\kylew\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\workspace\storychat\.planning\PROJECT.md
@C:\workspace\storychat\.planning\ROADMAP.md
@C:\workspace\storychat\.planning\STATE.md

# Database schema for reference
@C:\workspace\storychat\supabase\migrations\001_initial_schema.sql

# PlayerChatView for integration
@C:\workspace\storychat\.planning\phases\04-core-messaging\04-02-SUMMARY.md

# Kick player pattern for reference (soft delete)
@C:\workspace\storychat\.planning\phases\03-lobby-room-management\03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create leave room logic</name>
  <files>
    src/lib/leave-room.ts
  </files>
  <action>
    Create `src/lib/leave-room.ts` that exports:

    **leaveRoom(participantId: string): Promise&lt;void&gt;**
    - Updates participants table to soft-delete the participant
    - Query: `supabase.from('participants').update({ is_active: false }).eq('id', participantId)`
    - Uses async/await pattern
    - Error handling: throws error with descriptive message on failure
    - Success: returns void
    - Import supabase client from src/lib/supabase.ts

    **Soft delete pattern (matches kick functionality):**
    - Sets is_active = false (participant still exists in database)
    - Preserves audit trail
    - Existing useParticipants hook filters to is_active = true, so left participant disappears from participant lists
    - Existing kicked detection (postgres_changes subscription) will trigger redirect for the leaving participant

    Include JSDoc comment explaining soft delete behavior.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify TypeScript compiles.
    Verify leaveRoom exported from leave-room.ts.
    Verify UPDATE query sets is_active = false.
  </verify>
  <done>
    leave-room.ts exists with leaveRoom function.
    Function soft-deletes participant by setting is_active = false.
    TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PlayerSettingsMenu component</name>
  <files>
    src/components/PlayerSettingsMenu.tsx
  </files>
  <action>
    Create `src/components/PlayerSettingsMenu.tsx`:
    - Props: `{ roomCode: string; participantId: string; opened: boolean; onClose: () => void }`
    - Uses Mantine Modal component (or Drawer for mobile-friendly UX)
    - Title: "Game Settings"

    **Content sections:**

    1. **Room Code Display:**
       - Label: "Room Code"
       - Code displayed in large, monospace font (4 uppercase letters)
       - Copy button next to code (clipboard copy functionality)
       - Use Mantine Code component for styling
       - Notification on copy: "Room code copied!"

    2. **Leave Game Section:**
       - Divider between room code and leave section
       - Warning text: "Leaving will remove you from the game. You'll need the room code to rejoin."
       - "Leave Game" button (red/danger variant)
       - Icon: IconLogout from @tabler/icons-react
       - onClick triggers confirmation modal

    **Leave Confirmation Modal:**
    - Nested modal: "Leave Game?"
    - Body: "Are you sure you want to leave? You'll be removed from the room."
    - Two buttons: Cancel (secondary) and Confirm ("Leave Game", danger red)
    - On confirm:
      - Calls leaveRoom(participantId)
      - Shows loading state
      - On success: notification "Left game", navigate to "/" (home page) using useNavigate from react-router
      - On error: notification with error message

    **Styling:**
    - Gothic theme (dark background, crimson accents)
    - Mobile-friendly layout
    - Clear visual separation between sections

    Use Mantine notifications for feedback.
    Use react-router's useNavigate for navigation after leaving.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify TypeScript compiles.
    Verify PlayerSettingsMenu exports default component.
    Verify imports leaveRoom from leave-room.ts.
    Verify imports useNavigate from react-router.
  </verify>
  <done>
    PlayerSettingsMenu component exists with room code and leave game.
    Component has nested confirmation modal for leave action.
    TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate settings menu into PlayerChatView</name>
  <files>
    src/components/PlayerChatView.tsx
  </files>
  <action>
    Update `src/components/PlayerChatView.tsx`:

    **Add settings button:**
    - Import PlayerSettingsMenu component
    - Add state: `const [settingsOpened, setSettingsOpened] = useState(false)`
    - Add settings button in header (top-right corner)
      - Use ActionIcon component with IconSettings or IconDots from @tabler/icons-react
      - onClick opens settings: setSettingsOpened(true)
      - Position: absolute or flex-end in header
    - Render PlayerSettingsMenu at bottom of component:
      - Props: roomCode (get from useParticipants or pass as prop), participantId, opened=settingsOpened, onClose={() => setSettingsOpened(false)}

    **Get room code:**
    - PlayerChatView needs room code as prop OR fetch from useParticipants hook
    - Option 1: Add roomCode as prop to PlayerChatView (passed from RoomPage)
    - Option 2: Fetch from participants hook (room_id available from participant)
    - Recommend Option 1 for simplicity (RoomPage already has roomId from route params)

    **Layout:**
    - Settings icon should not interfere with chat header
    - Use Mantine Group or Flex for header layout
    - Ensure mobile-friendly touch target size (minimum 44x44px)

    Existing kicked detection (RoomPage subscribes to postgres_changes on participants.is_active) will redirect player to home after leaving.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify TypeScript compiles.
    Verify PlayerChatView imports PlayerSettingsMenu.
    Verify settings button renders in header.
    Verify roomCode prop passed to PlayerChatView or fetched from hook.
    Run `npm run dev` to check UI loads.
  </verify>
  <done>
    PlayerChatView has settings button in header.
    Button opens PlayerSettingsMenu on click.
    Room code and participant ID passed to menu.
    Settings integration complete.
  </done>
</task>

</tasks>

<verification>
**Automated checks:**
- [ ] TypeScript compiles without errors (`npx tsc --noEmit`)
- [ ] leaveRoom function exported from leave-room.ts
- [ ] PlayerSettingsMenu component exists
- [ ] PlayerChatView imports PlayerSettingsMenu
- [ ] Settings button renders in PlayerChatView header

**Manual verification:**
1. Start game as Player (join room, game active)
2. Verify settings icon appears in top-right of player chat view
3. Tap settings icon
4. Verify modal/drawer opens with "Game Settings" title
5. Verify room code displays correctly (4 uppercase letters)
6. Tap copy button next to room code
7. Verify notification "Room code copied!"
8. Paste in another app, verify code matches
9. Tap "Leave Game" button
10. Verify confirmation modal appears: "Leave Game?"
11. Tap "Cancel", verify modal closes without action
12. Tap "Leave Game" again, then tap "Confirm"
13. Verify notification "Left game"
14. Verify redirect to home page (/)
15. Storyteller view: verify player removed from participant list
16. Rejoin room with same code, verify can rejoin (soft delete allows reconnection)
</verification>

<success_criteria>
**PLAY-04 delivered:** Player can access settings to leave game or view room code

Player settings working:
- Settings menu accessible from player view
- Room code displayed and copyable
- Leave game with confirmation modal
- Soft delete pattern (is_active = false)
- Redirect to home after leaving
- Other participants see player removed in real-time
</success_criteria>

<output>
After completion, create `.planning/phases/05-game-state-views/05-04-SUMMARY.md`
</output>

---
phase: 03-lobby-room-management
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/pages/RoomPage.tsx
  - src/lib/rooms.ts
  - src/components/ParticipantList.tsx
autonomous: true

must_haves:
  truths:
    - "Storyteller can kick a player from the room"
    - "Kicked player sees removal message and redirects to home"
    - "Storyteller can edit a player's display name"
    - "Storyteller can select script (None only for v1)"
    - "Storyteller can tap Start Game and room status changes to active"
    - "All participants transition to game view when game starts"
  artifacts:
    - path: "src/lib/rooms.ts"
      provides: "Room management utilities"
      exports: ["kickParticipant", "updateParticipantName", "startGame"]
      contains: "UPDATE participants SET is_active = false"
    - path: "src/pages/RoomPage.tsx"
      provides: "Storyteller lobby controls"
      contains: "kickParticipant"
      contains: "startGame"
    - path: "src/components/ParticipantList.tsx"
      provides: "Player action buttons (kick, edit)"
      contains: "ActionIcon"
  key_links:
    - from: "src/pages/RoomPage.tsx"
      to: "src/lib/rooms.ts"
      via: "kickParticipant()"
      pattern: "kickParticipant\\("
    - from: "src/lib/rooms.ts"
      to: "participants table"
      via: "UPDATE is_active = false"
      pattern: "is_active.*false"
    - from: "useParticipants hook"
      to: "kicked participant"
      via: "DELETE event triggers redirect"
      pattern: "postgres_changes.*DELETE"
---

<objective>
Add Storyteller lobby management controls: kick players, edit names, select script, and start game.

Purpose: Enable Storyteller to manage the lobby and transition to active game state.
Output: Storyteller can control participants and initiate game start, with real-time updates for all participants.
</objective>

<execution_context>
@C:/Users/TwynS/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/TwynS/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:/workspace/storychat/.planning/PROJECT.md
@C:/workspace/storychat/.planning/ROADMAP.md
@C:/workspace/storychat/.planning/STATE.md

# Prior plan provides participant list foundation
@C:/workspace/storychat/.planning/phases/03-lobby-room-management/03-01-PLAN.md

# Existing room management code
@C:/workspace/storychat/src/lib/rooms.ts
@C:/workspace/storychat/src/pages/RoomPage.tsx
@C:/workspace/storychat/src/components/ParticipantList.tsx
@C:/workspace/storychat/supabase/migrations/001_initial_schema.sql
</context>

<tasks>

<task type="auto">
  <name>Add room management functions</name>
  <files>src/lib/rooms.ts</files>
  <action>
Add functions for Storyteller lobby management to existing rooms.ts file.

**New exports:**

1. **kickParticipant(participantId: string): Promise<void>**
   - Updates participant: `UPDATE participants SET is_active = false WHERE id = ?`
   - Use Supabase: `supabase.from('participants').update({ is_active: false }).eq('id', participantId)`
   - Throws error if update fails

2. **updateParticipantName(participantId: string, displayName: string): Promise<void>**
   - Updates participant: `UPDATE participants SET display_name = ?, updated_at = now() WHERE id = ?`
   - Use Supabase: `supabase.from('participants').update({ display_name, updated_at: new Date().toISOString() }).eq('id', participantId)`
   - Throws error if update fails

3. **startGame(roomId: string): Promise<void>**
   - Updates room: `UPDATE rooms SET status = 'active' WHERE id = ?`
   - Use Supabase: `supabase.from('rooms').update({ status: 'active' }).eq('id', roomId)`
   - Throws error if update fails

**Why these patterns:**
- Kick uses soft delete (`is_active = false`) not hard delete - preserves data for reconnection detection
- Name update includes `updated_at` for audit trail
- Game start is simple status transition - no phase change yet (Phase 5 will handle phase advancement)

**Import existing types:**
Use `Database` type from supabase.ts for type safety.

**Error handling:**
All functions should throw on database errors (caller handles user-facing notifications).
  </action>
  <verify>npx tsc --noEmit && grep -q "kickParticipant" src/lib/rooms.ts && grep -q "updateParticipantName" src/lib/rooms.ts && grep -q "startGame" src/lib/rooms.ts && grep -q "is_active.*false" src/lib/rooms.ts</verify>
  <done>rooms.ts exports kickParticipant, updateParticipantName, startGame functions with database updates</done>
</task>

<task type="auto">
  <name>Add Storyteller controls to lobby UI</name>
  <files>src/pages/RoomPage.tsx, src/components/ParticipantList.tsx</files>
  <action>
Add Storyteller-only controls to RoomPage and update ParticipantList to support actions.

**RoomPage.tsx changes:**

1. Import new functions from rooms.ts: `kickParticipant`, `updateParticipantName`, `startGame`
2. Import Mantine components: `Button`, `Select`, `Modal`, `TextInput`, `notifications`
3. Add state for script selection: `const [script, setScript] = useState('none')`
4. Add state for edit modal: `const [editingParticipant, setEditingParticipant] = useState<{id: string, name: string} | null>(null)`

**Storyteller view additions (only when role === 'storyteller'):**
- Script selector: Mantine `Select` with label "Script", data: `[{value: 'none', label: 'None (No Roles)'}]`, value bound to `script` state
  - Position above participant list
  - Note: v1 only supports "None", v2 will add Trouble Brewing
- Start Game button: Mantine `Button` at bottom, color crimson, size lg, fullWidth
  - Label: "Start Game"
  - onClick: call `startGame(roomId)`, show success notification, status change will trigger re-render
  - Disabled if participants.length < 2 (need at least Storyteller + 1 player)
  - Error handling: show error notification on failure

**ParticipantList.tsx changes:**

1. Add optional props:
   - `onKick?: (participantId: string) => void`
   - `onEdit?: (participantId: string, currentName: string) => void`
   - `isStoryteller?: boolean`

2. For each participant (when isStoryteller=true AND participant is not current user):
   - Add action buttons to the right side of the Group
   - Use Mantine `ActionIcon` (size sm, variant subtle)
   - Edit icon: `IconEdit` from `@tabler/icons-react`, onClick: `onEdit(participant.id, participant.display_name)`
   - Kick icon: `IconX` from `@tabler/icons-react`, color red, onClick: `onKick(participant.id)`
   - Use `Group` with `justify="space-between"` to position name on left, actions on right

**Edit modal in RoomPage:**
- Mantine `Modal` controlled by `editingParticipant !== null`
- Title: "Edit Player Name"
- TextInput with value bound to local state, validation: 2-20 characters
- Save button: calls `updateParticipantName()`, closes modal, shows success notification
- Cancel button: closes modal without saving

**Kicked player detection:**
Add `useEffect` in RoomPage that watches `participant.is_active`:
- If participant.is_active becomes false, redirect to `/?error=kicked` (new error code)
- Update HomePage to handle `kicked` error: "You were removed from the room by the Storyteller."

**Important:** Don't allow Storyteller to kick themselves (hide actions for currentUserId).
  </action>
  <verify>npx tsc --noEmit && grep -q "startGame" src/pages/RoomPage.tsx && grep -q "kickParticipant" src/pages/RoomPage.tsx && grep -q "ActionIcon" src/components/ParticipantList.tsx && grep -q "onKick" src/components/ParticipantList.tsx</verify>
  <done>Storyteller can kick players, edit names, select script (None only), and start game. Kicked players redirect to home with error message.</done>
</task>

<task type="auto">
  <name>Add game status transition handling</name>
  <files>src/pages/RoomPage.tsx, src/hooks/useParticipants.ts</files>
  <action>
Handle room status changes and transition to game view when Storyteller starts the game.

**useParticipants.ts enhancement:**
Add room status to subscription:
- Also subscribe to Postgres Changes on `rooms` table for UPDATE events
- Filter by `id=eq.${roomId}`
- Add state: `const [roomStatus, setRoomStatus] = useState<'lobby' | 'active' | 'ended'>('lobby')`
- Fetch initial room status in the same query (add `.select('*, rooms!inner(status)')` to participant query, or separate room query)
- Update roomStatus when room UPDATE event fires
- Return roomStatus in hook: `{ participants, loading, roomStatus }`

**RoomPage.tsx status handling:**
1. Get roomStatus from useParticipants hook
2. Add conditional rendering based on roomStatus:
   - `lobby`: Show current lobby UI (participant list, controls)
   - `active`: Show placeholder "Game is active - messaging coming in Phase 4"
   - `ended`: Show "Game has ended" message
3. When status changes from 'lobby' to 'active', show success notification: "Game started!"

**Why this approach:**
Status changes are rare events (once per game), so adding room subscription to useParticipants is efficient. Alternative would be separate useRoom hook, but that's overkill for single field.

**Migration path:**
Phase 4 will replace the active status placeholder with actual game UI (messaging interface).
  </action>
  <verify>npx tsc --noEmit && grep -q "roomStatus" src/hooks/useParticipants.ts && grep -q "roomStatus" src/pages/RoomPage.tsx && grep -q "status.*active" src/pages/RoomPage.tsx</verify>
  <done>Room status changes trigger real-time UI updates. Starting game transitions all participants from lobby to game view.</done>
</task>

</tasks>

<verification>
**Manual checks:**
1. As Storyteller, open lobby with 2+ players
2. Click edit icon on a player, change their name, verify name updates in real-time
3. Click kick icon on a player, verify they are removed from list immediately
4. In kicked player's tab, verify redirect to home with error message "You were removed from the room"
5. As Storyteller, verify Start Game button is disabled with only 1 player
6. Add a second player, click Start Game
7. Verify all tabs show "Game started!" notification and transition to active view

**Code checks:**
- TypeScript compiles without errors
- rooms.ts exports all three new functions
- ParticipantList accepts onKick and onEdit props
- RoomPage shows Storyteller controls only when role === 'storyteller'
- useParticipants returns roomStatus
</verification>

<success_criteria>
- [ ] kickParticipant sets is_active to false and kicked player redirects to home
- [ ] updateParticipantName updates display_name and all participants see change
- [ ] Script selector shows "None" option (only option for v1)
- [ ] Start Game button is disabled with fewer than 2 participants
- [ ] Clicking Start Game sets room status to 'active'
- [ ] All participants see status change and transition to game view
- [ ] Storyteller cannot kick themselves
- [ ] Edit modal validates name length (2-20 characters)
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `C:/workspace/storychat/.planning/phases/03-lobby-room-management/03-02-SUMMARY.md`
</output>

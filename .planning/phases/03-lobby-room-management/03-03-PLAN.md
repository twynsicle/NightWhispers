---
phase: 03-lobby-room-management
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/QRCodeGenerator.tsx
  - src/pages/RoomPage.tsx
  - supabase/functions/cleanup-expired-rooms/index.ts
autonomous: true

must_haves:
  truths:
    - "Storyteller can generate QR code for room join URL"
    - "Players can scan QR code to navigate to join page"
    - "Rooms with no activity for 1 hour are automatically deleted"
    - "Deleted rooms remove all participants and messages (cascading)"
  artifacts:
    - path: "src/components/QRCodeGenerator.tsx"
      provides: "QR code generation component"
      exports: ["QRCodeGenerator"]
      min_lines: 30
    - path: "src/pages/RoomPage.tsx"
      provides: "QR code modal trigger"
      contains: "QRCodeGenerator"
    - path: "supabase/functions/cleanup-expired-rooms/index.ts"
      provides: "Scheduled room cleanup Edge Function"
      contains: "DELETE FROM rooms WHERE expires_at"
  key_links:
    - from: "src/components/QRCodeGenerator.tsx"
      to: "qrcode library"
      via: "QRCode.toDataURL()"
      pattern: "QRCode\\.toDataURL"
    - from: "src/pages/RoomPage.tsx"
      to: "QRCodeGenerator"
      via: "Modal with QR code"
      pattern: "QRCodeGenerator.*url"
    - from: "supabase/functions/cleanup-expired-rooms/index.ts"
      to: "rooms table"
      via: "DELETE WHERE expires_at < now()"
      pattern: "DELETE.*expires_at"
---

<objective>
Add QR code sharing for easy room joining and automated cleanup for expired rooms.

Purpose: Improve UX for in-person game nights (scan to join) and prevent database bloat from abandoned rooms.
Output: QR code component for room sharing and Supabase Edge Function for scheduled cleanup.
</objective>

<execution_context>
@C:/Users/TwynS/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/TwynS/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:/workspace/storychat/.planning/PROJECT.md
@C:/workspace/storychat/.planning/ROADMAP.md
@C:/workspace/storychat/.planning/STATE.md

# Database schema with expires_at field
@C:/workspace/storychat/supabase/migrations/001_initial_schema.sql

# Existing room page to integrate QR code
@C:/workspace/storychat/src/pages/RoomPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Create QR code generator component</name>
  <files>src/components/QRCodeGenerator.tsx</files>
  <action>
Install qrcode library and create QR code component.

**Installation:**
```bash
npm install qrcode @types/qrcode
```

**Component implementation:**

Export `QRCodeGenerator` component with props:
- `url: string` - The URL to encode in QR code
- `size?: number` - QR code size in pixels (default 256)

**Functionality:**
- Use `useEffect` to generate QR code data URL when url or size changes
- State: `const [qrDataUrl, setQrDataUrl] = useState<string | null>(null)`
- Call `QRCode.toDataURL(url, { width: size, margin: 2, color: { dark: '#c92a2a', light: '#1a1b1e' } })` to generate
- Store result in state
- Show loading state (Mantine `Skeleton` with height/width = size) while generating
- Display QR code image once generated

**UI Structure:**
- Stack with centered alignment
- QR code image (rendered from data URL)
- Text below: "Scan to join" (size sm, dimmed, center aligned)
- Copy URL button below QR code (use Mantine `Button` with `IconCopy` from `@tabler/icons-react`)
  - onClick: copy URL to clipboard using `navigator.clipboard.writeText()`, show notification "Link copied!"

**Styling:**
- QR code colors: crimson (#c92a2a) for dark, dark.9 (#1a1b1e) for light background
- Border radius on QR image: md
- Mobile-friendly: QR code should be large enough to scan (256px default)

**Error handling:**
If QRCode.toDataURL fails, show error Text: "Failed to generate QR code"
  </action>
  <verify>npx tsc --noEmit && grep -q "QRCodeGenerator" src/components/QRCodeGenerator.tsx && grep -q "QRCode.toDataURL" src/components/QRCodeGenerator.tsx && npm list qrcode</verify>
  <done>QRCodeGenerator component renders QR code with room join URL, supports clipboard copy</done>
</task>

<task type="auto">
  <name>Add QR code modal to RoomPage</name>
  <files>src/pages/RoomPage.tsx</files>
  <action>
Integrate QR code generator into RoomPage for easy sharing.

**Changes:**
1. Import QRCodeGenerator component
2. Import Mantine `Modal` and `Button`, `IconQrcode` from `@tabler/icons-react`
3. Add state: `const [qrModalOpen, setQrModalOpen] = useState(false)`
4. Construct join URL: `const joinUrl = \`${window.location.origin}/join?code=${participant.rooms.code}\``

**UI additions (visible to ALL participants):**
Below the existing room code display, add:
- Button with QRCode icon, label "Show QR Code", variant light, fullWidth on mobile
- onClick: open modal (`setQrModalOpen(true)`)

**Modal structure:**
- Title: "Scan to Join Room"
- Content: `<QRCodeGenerator url={joinUrl} />`
- Close button: standard modal close (X in corner)
- Size: auto (fits QR code)

**Mobile optimization:**
On mobile viewports, QR code might be scanned by another device, so showing it makes sense. On desktop, Storyteller can display it for players to scan.

**Why include join?code query param:**
Pre-fills the room code on the join page, so users can proceed directly to session setup after scanning. Better UX than scanning just to see the code.

**Position:**
Place QR button below room code, above participant list. Available in both lobby and active game states.
  </action>
  <verify>npx tsc --noEmit && grep -q "QRCodeGenerator" src/pages/RoomPage.tsx && grep -q "qrModalOpen" src/pages/RoomPage.tsx && grep -q "IconQrcode" src/pages/RoomPage.tsx && grep -q "window.location.origin" src/pages/RoomPage.tsx</verify>
  <done>RoomPage has "Show QR Code" button that opens modal with scannable QR code for room joining</done>
</task>

<task type="auto">
  <name>Create room cleanup Edge Function</name>
  <files>supabase/functions/cleanup-expired-rooms/index.ts</files>
  <action>
Create Supabase Edge Function for scheduled deletion of expired rooms.

**Directory setup:**
Create `supabase/functions/cleanup-expired-rooms/` directory.

**index.ts implementation:**

```typescript
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

serve(async (req) => {
  try {
    // Create Supabase client with service role key for admin access
    const supabaseUrl = Deno.env.get('SUPABASE_URL')!
    const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
    const supabase = createClient(supabaseUrl, supabaseServiceKey)

    // Delete rooms where expires_at is in the past
    const { data, error } = await supabase
      .from('rooms')
      .delete()
      .lt('expires_at', new Date().toISOString())
      .select('id, code')

    if (error) {
      console.error('Error deleting expired rooms:', error)
      return new Response(JSON.stringify({ error: error.message }), {
        status: 500,
        headers: { 'Content-Type': 'application/json' },
      })
    }

    console.log(`Deleted ${data?.length || 0} expired rooms:`, data?.map(r => r.code).join(', '))

    return new Response(
      JSON.stringify({
        success: true,
        deletedCount: data?.length || 0,
        deletedRooms: data?.map(r => r.code) || [],
      }),
      {
        status: 200,
        headers: { 'Content-Type': 'application/json' },
      }
    )
  } catch (err) {
    console.error('Unexpected error:', err)
    return new Response(JSON.stringify({ error: String(err) }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' },
    })
  }
})
```

**Why this works:**
- Cascading deletes (ON DELETE CASCADE) automatically remove participants and messages
- Service role key bypasses RLS policies
- Function can be invoked via HTTP or scheduled with pg_cron

**Deployment:**
After creating the file, deploy with: `npx supabase functions deploy cleanup-expired-rooms`

**Scheduling (manual step, not in plan):**
User will need to set up pg_cron or external scheduler (Vercel Cron, GitHub Actions) to invoke this function hourly. Document in verification output, but don't implement scheduler in this plan.

**Testing:**
Function can be manually invoked: `npx supabase functions invoke cleanup-expired-rooms`
  </action>
  <verify>grep -q "cleanup-expired-rooms" supabase/functions/cleanup-expired-rooms/index.ts && grep -q "expires_at" supabase/functions/cleanup-expired-rooms/index.ts && grep -q "DELETE" supabase/functions/cleanup-expired-rooms/index.ts || echo "Edge function created"</verify>
  <done>Edge Function deletes rooms where expires_at < now(), with cascading participant/message cleanup</done>
</task>

</tasks>

<verification>
**Manual checks:**
1. In RoomPage, click "Show QR Code" button
2. Verify modal opens with QR code displayed
3. Scan QR code with phone camera, verify it navigates to join page with pre-filled code
4. Click "Copy Link" button, verify notification shows and clipboard contains join URL
5. Deploy Edge Function: `npx supabase functions deploy cleanup-expired-rooms`
6. Test Edge Function: `npx supabase functions invoke cleanup-expired-rooms`
7. Check logs for successful deletion count

**Code checks:**
- TypeScript compiles without errors
- qrcode package installed in package.json
- QRCodeGenerator component uses QRCode.toDataURL
- RoomPage imports and renders QRCodeGenerator in Modal
- Edge Function exists at supabase/functions/cleanup-expired-rooms/index.ts

**Deployment notes:**
Edge Function is deployed but NOT scheduled. User must configure pg_cron or external scheduler to invoke hourly:
```sql
SELECT cron.schedule(
  'cleanup-expired-rooms',
  '0 * * * *', -- Every hour
  $$SELECT net.http_post(
    url := 'https://PROJECT_REF.supabase.co/functions/v1/cleanup-expired-rooms',
    headers := '{"Authorization": "Bearer SERVICE_ROLE_KEY"}'::jsonb
  )$$
);
```
</verification>

<success_criteria>
- [ ] QRCodeGenerator component generates QR code with room join URL
- [ ] QR code uses gothic theme colors (crimson for dark pixels)
- [ ] Copy link button copies join URL to clipboard and shows notification
- [ ] RoomPage has "Show QR Code" button visible to all participants
- [ ] Modal displays QR code centered with "Scan to join" text
- [ ] Edge Function deletes rooms where expires_at < now()
- [ ] Edge Function logs deleted room count and codes
- [ ] Cascading deletes remove participants and messages when room deleted
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `C:/workspace/storychat/.planning/phases/03-lobby-room-management/03-03-SUMMARY.md`

**Note for user:** Edge Function is deployed but requires scheduling setup. See verification section for pg_cron configuration or use Vercel Cron / GitHub Actions to invoke hourly.
</output>

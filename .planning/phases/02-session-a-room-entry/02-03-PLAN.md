---
phase: 02-session-a-room-entry
plan: 03
type: execute
wave: 3
depends_on: [02-02]
files_modified:
  - src/App.tsx
  - src/pages/RoomPage.tsx
  - src/pages/HomePage.tsx
autonomous: false

must_haves:
  truths:
    - "User who refreshes browser automatically rejoins their room"
    - "User kicked from room sees error and returns to home"
    - "User without session is redirected to home page"
    - "Room code is visible in room interface for sharing"
    - "Session persists across browser refresh (SESS-03, SESS-04)"
    - "Expired session shows clear error (SESS-05)"
  artifacts:
    - path: "src/App.tsx"
      provides: "Root-level session recovery"
      contains: "useAuth.*useEffect"
    - path: "src/pages/RoomPage.tsx"
      provides: "Room code display and rejoin logic"
      contains: "rooms.code"
    - path: "src/pages/HomePage.tsx"
      provides: "Error message display"
      contains: "searchParams.*error"
  key_links:
    - from: "src/App.tsx"
      to: "useAuth hook"
      via: "session recovery on mount"
      pattern: "useAuth\\(\\)"
    - from: "src/pages/RoomPage.tsx loader"
      to: "redirect with error"
      via: "session validation"
      pattern: "redirect.*error="
    - from: "src/pages/HomePage.tsx"
      to: "useSearchParams"
      via: "error parameter display"
      pattern: "searchParams\\.get\\('error'\\)"
---

<objective>
Complete session persistence and auto-rejoin functionality, ensuring users seamlessly reconnect to their rooms after browser refresh and see clear error messages when sessions expire or access is denied.

Purpose: Delivers requirements SESS-03, SESS-04, SESS-05, and ROOM-06, completing the session and room entry user experience.

Output: Working auto-rejoin flow with error handling and room code visibility.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-session-a-room-entry/02-RESEARCH.md

# This plan's dependencies
@.planning/phases/02-session-a-room-entry/02-01-SUMMARY.md (when it exists)
@.planning/phases/02-session-a-room-entry/02-02-SUMMARY.md (when it exists)

# Existing code
@src/hooks/useAuth.ts
@src/lib/rooms.ts
@src/pages/RoomPage.tsx
@src/pages/HomePage.tsx
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Implement session recovery and auto-rejoin flow</name>
  <files>src/App.tsx, src/pages/RoomPage.tsx</files>
  <action>
**File: src/App.tsx**

Add root-level session recovery following RESEARCH.md Pattern 1:

1. **Session state management:**
   - Import useAuth hook
   - Call useAuth() at top level to enable session recovery
   - Show loading skeleton while session.loading is true
   - Render RouterProvider once loading is false

2. **Structure:**
   ```tsx
   function App() {
     const { loading } = useAuth()

     if (loading) {
       return (
         <Center h="100vh">
           <Loader size="lg" />
         </Center>
       )
     }

     return <RouterProvider router={router} />
   }
   ```

3. **Imports:**
   - Center, Loader from @mantine/core
   - useAuth from @/hooks/useAuth

This ensures session is recovered from localStorage before any routing happens, enabling auto-rejoin.

**File: src/pages/RoomPage.tsx**

Add room code display to UI:

1. **Update component UI:**
   - Add section showing room code from participant.rooms.code
   - Use Mantine Code component with block prop for visibility
   - Add Text helper: "Share this code for others to join"
   - Style with crimson color for emphasis

2. **UI structure addition:**
   ```tsx
   <Stack gap="xs">
     <Text size="sm" c="dimmed">Room Code:</Text>
     <Code block fz="xl" ta="center">{participant.rooms.code}</Code>
     <Text size="xs" c="dimmed" ta="center">Share this code for others to join</Text>
   </Stack>
   ```

3. **Imports:**
   - Add Code to @mantine/core imports

DO NOT add manual rejoin logic - loader pattern handles this automatically when user refreshes.
  </action>
  <verify>
npx tsc --noEmit
grep -n "useAuth.*loading\|Loader\|loading.*true" src/App.tsx
grep -n "rooms.code\|Code block\|Share this code" src/pages/RoomPage.tsx
  </verify>
  <done>
App.tsx uses useAuth hook and shows loader while session recovery happens. RoomPage.tsx displays room code using Mantine Code component with helper text. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Add error handling and user feedback for session failures</name>
  <files>src/pages/HomePage.tsx, src/pages/RoomPage.tsx</files>
  <action>
**File: src/pages/HomePage.tsx**

Add error message display for redirect scenarios:

1. **Read error param:**
   - Use useSearchParams from react-router
   - Get error parameter: `const [searchParams] = useSearchParams()`
   - Read error value: `searchParams.get('error')`

2. **Error messages:**
   - Map error codes to user-friendly messages:
     - 'no-session' -> "Your session has expired. Please join again."
     - 'not-participant' -> "You are not in this room. You may have been kicked or the room was deleted."
     - 'session-invalid' -> "Your session is no longer valid. Please join again."
   - Default: "An error occurred. Please try again."

3. **Display:**
   - If error exists, show Alert component at top of Stack
   - Use Alert color="red" variant="filled" title="Access Denied"
   - Show mapped error message in Alert content
   - Add close button (withCloseButton prop)
   - On close, clear error param by navigating to '/'

4. **Imports:**
   - Alert from @mantine/core
   - useSearchParams from react-router

**File: src/pages/RoomPage.tsx (loader)**

Update loader to use specific error codes:

1. **Session check:**
   - If no session, redirect to `/?error=session-invalid`

2. **Participant check:**
   - If no participant, redirect to `/?error=not-participant`

DO NOT show alerts in RoomPage component - errors are shown on HomePage after redirect.
  </action>
  <verify>
npx tsc --noEmit
grep -n "useSearchParams\|Alert.*error\|no-session\|not-participant" src/pages/HomePage.tsx
grep -n "redirect.*error=session-invalid\|redirect.*error=not-participant" src/pages/RoomPage.tsx
  </verify>
  <done>
HomePage displays Alert with user-friendly error messages based on URL param. RoomPage loader redirects with specific error codes (session-invalid, not-participant). TypeScript compiles without errors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete session and room entry flow with anonymous auth, room creation/joining, auto-rejoin on refresh, and error handling.
  </what-built>
  <how-to-verify>
**Test Scenario 1: Storyteller creates room**
1. Start dev server: `npm run dev`
2. Visit http://localhost:5173
3. Click "Create Room"
4. Enter display name (2-20 chars), select emoji avatar
5. Click submit
6. Verify: 4-letter room code appears
7. Verify: Auto-redirects to room page after 2 seconds
8. Verify: Room page shows room code, display name, avatar, "Storyteller" badge

**Test Scenario 2: Player joins room**
1. Open new incognito window
2. Visit http://localhost:5173
3. Click "Join Room"
4. Enter display name, select avatar
5. Enter the 4-letter code from Storyteller's screen
6. Click "Join"
7. Verify: Redirects to room page
8. Verify: Room page shows room code, display name, avatar, "Player" badge

**Test Scenario 3: Auto-rejoin on refresh (SESS-04)**
1. As Storyteller or Player in room page
2. Refresh browser (F5 or Cmd+R)
3. Verify: Brief loading screen appears
4. Verify: Automatically returns to room page
5. Verify: Room code, display name, avatar still displayed
6. Verify: No re-entry of credentials required

**Test Scenario 4: Invalid room code**
1. Visit http://localhost:5173
2. Click "Join Room"
3. Enter display name, select avatar
4. Enter code "XXXX" (non-existent)
5. Click "Join"
6. Verify: Error message appears in form
7. Verify: Can retry with different code

**Test Scenario 5: Session expiry error (simulate)**
1. In room page, open browser DevTools
2. Application tab -> Local Storage
3. Clear all Supabase auth keys
4. Refresh page
5. Verify: Redirects to home page
6. Verify: Red alert shows "Your session is no longer valid. Please join again."

**Test Scenario 6: Gothic theme (UX-01)**
1. On any page, verify visual elements:
   - Dark background (default dark mode)
   - Crimson color on primary buttons and titles
   - Mobile-first responsive design (test at 375px viewport)

**Mobile Testing (UX-02):**
1. Open DevTools, switch to mobile viewport (iPhone 12, 390x844)
2. Verify: All buttons are large enough for touch (min 44px height)
3. Verify: Avatar grid displays 4 columns on mobile
4. Verify: Text is readable without zooming
5. Verify: Forms don't require horizontal scrolling

**Pass Criteria:**
- [ ] Storyteller can create room and see code
- [ ] Player can join room with valid code
- [ ] Both auto-rejoin after browser refresh
- [ ] Invalid code shows error
- [ ] Session expiry shows clear error and redirects to home
- [ ] Gothic theme applied (dark + crimson)
- [ ] Mobile-friendly layout on 390px viewport
  </how-to-verify>
  <resume-signal>
Type "approved" if all tests pass, or describe any issues found.
  </resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npx tsc --noEmit`
2. App.tsx uses useAuth hook and shows loading state
3. RoomPage displays room code using Code component
4. HomePage displays error alerts based on URL params
5. RoomPage loader redirects with specific error codes
6. All pages follow gothic theme styling
7. Mobile-responsive layout verified at 375px-390px viewport
</verification>

<success_criteria>
- [ ] Session persists across browser refresh (SESS-03) ✓
- [ ] User auto-rejoins room on app reload if session valid (SESS-04) ✓
- [ ] User sees error and returns to home if session expired/kicked (SESS-05) ✓
- [ ] Room code visible in room interface (ROOM-06) ✓
- [ ] Gothic visual theme applied (UX-01) ✓
- [ ] Mobile-first responsive design (UX-02) ✓
- [ ] User verification confirms all flows work end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/02-session-a-room-entry/02-03-SUMMARY.md` using the standard summary template.

Mark requirements complete in REQUIREMENTS.md:
- [x] SESS-01: User can set display name before joining game
- [x] SESS-02: User can select avatar from pre-made set
- [x] SESS-03: Session token persists in localStorage for reconnection
- [x] SESS-04: User auto-rejoins room on app reload if session valid
- [x] SESS-05: User sees error and returns to home if session expired/kicked
- [x] ROOM-01: Storyteller can create a room and receive a 4-letter code
- [x] ROOM-02: Player can join a room by entering a 4-letter code
- [x] ROOM-06: Participants can view room code for sharing/rejoining
- [x] UX-01: Gothic visual theme (dark background, crimson/gold accents)
- [x] UX-02: Mobile-first responsive design
</output>

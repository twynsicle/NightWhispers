---
phase: 02-session-a-room-entry
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - src/components/AvatarSelector.tsx
  - src/pages/HomePage.tsx
  - src/pages/SessionSetupPage.tsx
  - src/pages/CreateRoomPage.tsx
  - src/pages/JoinRoomPage.tsx
  - src/pages/RoomPage.tsx
  - src/App.tsx
  - src/main.tsx
autonomous: true

must_haves:
  truths:
    - "User can select from 8-12 emoji avatars in a grid"
    - "User can input display name with validation (2-20 chars)"
    - "Storyteller sees 4-letter room code after creating room"
    - "Player can enter 4-letter code to join room"
    - "Room page is protected (requires session + participant record)"
    - "Gothic theme applied to all pages (dark background, crimson accents)"
  artifacts:
    - path: "src/components/AvatarSelector.tsx"
      provides: "Grid of emoji avatars with selection state"
      exports: ["AvatarSelector"]
      min_lines: 30
    - path: "src/pages/HomePage.tsx"
      provides: "Entry point with create/join choice"
      min_lines: 20
    - path: "src/pages/SessionSetupPage.tsx"
      provides: "Display name + avatar form"
      min_lines: 40
    - path: "src/pages/CreateRoomPage.tsx"
      provides: "Room creation flow"
      min_lines: 30
    - path: "src/pages/JoinRoomPage.tsx"
      provides: "Room code entry form"
      min_lines: 35
    - path: "src/pages/RoomPage.tsx"
      provides: "Protected game interface"
      min_lines: 25
    - path: "src/App.tsx"
      provides: "Router configuration"
      min_lines: 50
  key_links:
    - from: "src/pages/SessionSetupPage.tsx"
      to: "@mantine/form.useForm"
      via: "form validation"
      pattern: "useForm.*validate"
    - from: "src/pages/CreateRoomPage.tsx"
      to: "src/lib/rooms.createRoom"
      via: "import and call"
      pattern: "createRoom\\("
    - from: "src/pages/JoinRoomPage.tsx"
      to: "src/lib/rooms.joinRoom"
      via: "import and call"
      pattern: "joinRoom\\("
    - from: "src/App.tsx"
      to: "react-router.createBrowserRouter"
      via: "route configuration"
      pattern: "createBrowserRouter"
    - from: "src/pages/RoomPage.tsx loader"
      to: "useAuth session"
      via: "protected route check"
      pattern: "getSession.*redirect"
---

<objective>
Build user-facing pages and routing for session setup, room creation/joining, and protected room access with gothic-themed mobile-first UI.

Purpose: Delivers the complete user journey from landing page through session setup to room entry, with React Router protecting authenticated routes.

Output: Full page structure with routing, forms, and navigation following Mantine mobile-first patterns.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-session-a-room-entry/02-RESEARCH.md

# This plan's dependencies
@.planning/phases/02-session-a-room-entry/02-01-SUMMARY.md (when it exists)

# Existing code
@src/lib/supabase.ts
@src/theme.ts
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Create AvatarSelector component and session setup page</name>
  <files>src/components/AvatarSelector.tsx, src/pages/SessionSetupPage.tsx</files>
  <action>
**File 1: src/components/AvatarSelector.tsx**

Create emoji avatar selector following RESEARCH.md recommendation:

1. **Props interface:**
   - `value: string` (current selection)
   - `onChange: (avatar: string) => void` (selection handler)
   - `error?: string` (validation error)

2. **Avatar options:**
   - Use emoji array: ['üßô‚Äç‚ôÇÔ∏è', 'üßõ‚Äç‚ôÄÔ∏è', 'üßü‚Äç‚ôÇÔ∏è', 'üëª', 'üé≠', 'üïµÔ∏è', 'ü¶á', 'üåô', '‚ö∞Ô∏è', 'üîÆ', 'üó°Ô∏è', 'üõ°Ô∏è']
   - 12 gothic-themed emoji (zero assets, accessible, mobile-friendly)

3. **UI structure:**
   - Mantine Grid with cols={{ base: 4, sm: 6 }} for responsive layout
   - Each avatar in Grid.Col with Button component
   - Selected avatar has variant="filled" color="crimson"
   - Unselected avatars have variant="light"
   - Button size="xl" for mobile touch targets
   - Show error below grid using Text color="red" if error prop present

4. **Accessibility:**
   - Each button has aria-label="Select {emoji}"
   - aria-pressed={value === emoji} for screen readers

Import: Grid, Button, Text from @mantine/core

**File 2: src/pages/SessionSetupPage.tsx**

Create session setup page following Pattern 7 from RESEARCH.md:

1. **Form setup:**
   - Use `useForm` from @mantine/form
   - Initial values: { displayName: '', avatar: '' }
   - Validators: displayName uses `hasLength({ min: 2, max: 20 })`, avatar uses `isNotEmpty()`
   - Import validators from @mantine/form

2. **Form submission:**
   - If not authenticated, call useAuth's signInAnonymously() first
   - Store displayName and avatar in localStorage for next step
   - Navigate to /create or /join based on URL param (?next=create or ?next=join)
   - Use `useNavigate` from react-router
   - Use `useSearchParams` to read ?next param

3. **UI structure:**
   - Container size="xs" centered
   - Stack gap="lg"
   - Title "Join the Night" variant="h2" color="crimson"
   - TextInput for displayName with label, placeholder, form binding
   - AvatarSelector component with form binding
   - Button type="submit" fullWidth, loading state during auth
   - Gothic theme: dark background, crimson accents per UX-01

4. **Imports:**
   - Container, Stack, Title, TextInput, Button from @mantine/core
   - useForm, hasLength, isNotEmpty from @mantine/form
   - useNavigate, useSearchParams from react-router
   - useAuth from @/hooks/useAuth
   - AvatarSelector from @/components/AvatarSelector

DO NOT store session token manually - Supabase handles this. DO NOT navigate before auth completes - wait for signInAnonymously promise.
  </action>
  <verify>
npx tsc --noEmit
grep -n "AvatarSelector\|Grid.*cols\|Button.*variant" src/components/AvatarSelector.tsx
grep -n "useForm.*validate\|hasLength\|signInAnonymously\|localStorage" src/pages/SessionSetupPage.tsx
  </verify>
  <done>
AvatarSelector component renders emoji grid with selection state and validation error display. SessionSetupPage has Mantine form with validation, creates anonymous session, stores displayName/avatar in localStorage, and navigates based on ?next param. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Create room entry pages (Home, Create, Join)</name>
  <files>src/pages/HomePage.tsx, src/pages/CreateRoomPage.tsx, src/pages/JoinRoomPage.tsx</files>
  <action>
**File 1: src/pages/HomePage.tsx**

Create landing page with create/join choice:

1. **UI structure:**
   - Container size="xs" centered with padding
   - Stack gap="xl" for vertical layout
   - Title "Night Whispers" variant="h1" ta="center" color="crimson"
   - Text subtitle: "Private messages for social deduction games"
   - Button "Create Room" (Storyteller) -> navigate to /setup?next=create, fullWidth, size="lg"
   - Button "Join Room" (Player) -> navigate to /setup?next=join, fullWidth, size="lg", variant="light"
   - Gothic styling: dark background, crimson primary, gold accents

2. **Imports:**
   - Container, Stack, Title, Text, Button from @mantine/core
   - useNavigate from react-router

**File 2: src/pages/CreateRoomPage.tsx**

Create room creation flow following RESEARCH.md Pattern 4:

1. **On mount:**
   - Check for session using useAuth
   - If no session, redirect to /setup?next=create
   - Retrieve displayName and avatar from localStorage
   - If missing, redirect to /setup?next=create
   - Call createRoom(session.user.id, true) immediately
   - Show loading state while creating
   - On success, show room code in large text
   - Navigate to /room/:roomId after 2 seconds (auto-redirect)

2. **UI structure:**
   - Container size="xs" centered
   - Stack gap="lg"
   - Title "Room Created" color="crimson"
   - Text "Share this code with your players:"
   - Text (room code) size="3rem" fw={700} ta="center" ff="monospace" (large, bold, centered)
   - Text helper: "Players can enter this code to join"
   - Loading skeleton while createRoom is pending

3. **Error handling:**
   - Catch createRoom errors
   - Show notification using @mantine/notifications
   - Button to retry

4. **Imports:**
   - Container, Stack, Title, Text, Skeleton from @mantine/core
   - notifications.show from @mantine/notifications
   - useAuth from @/hooks/useAuth
   - createRoom from @/lib/rooms
   - useNavigate from react-router
   - useState, useEffect from react

**File 3: src/pages/JoinRoomPage.tsx**

Create room joining flow following RESEARCH.md Pattern 5:

1. **Form setup:**
   - Use useForm from @mantine/form
   - Initial value: { roomCode: '' }
   - Validator: roomCode must be exactly 4 characters, uppercase transform
   - Custom validator: `/^[A-Z0-9]{4}$/` pattern

2. **Form submission:**
   - Check session (redirect to /setup?next=join if none)
   - Retrieve displayName and avatar from localStorage (redirect if missing)
   - Call joinRoom(roomCode, session.user.id, displayName, avatar)
   - On success, navigate to /room/:roomId
   - On error (room not found), show error in form
   - Loading state during joinRoom call

3. **UI structure:**
   - Container size="xs" centered
   - Stack gap="lg"
   - Title "Join Room" color="crimson"
   - TextInput for roomCode, label="Room Code", placeholder="ABCD", maxLength={4}, uppercase transform
   - Text helper: "Enter the 4-letter code from your Storyteller"
   - Button "Join" type="submit" fullWidth loading={isLoading}

4. **Imports:**
   - Container, Stack, Title, Text, TextInput, Button from @mantine/core
   - useForm, matches from @mantine/form
   - useAuth from @/hooks/useAuth
   - joinRoom from @/lib/rooms
   - useNavigate from react-router
   - useState from react

DO NOT manually uppercase input - use Mantine's `text-transform: uppercase` style. DO NOT allow join before session exists.
  </action>
  <verify>
npx tsc --noEmit
grep -n "navigate.*setup\|Button.*Create Room" src/pages/HomePage.tsx
grep -n "createRoom\|room.code\|localStorage.getItem" src/pages/CreateRoomPage.tsx
grep -n "joinRoom\|roomCode.*validator\|matches.*A-Z0-9" src/pages/JoinRoomPage.tsx
  </verify>
  <done>
HomePage has create/join buttons navigating to /setup with ?next param. CreateRoomPage creates room on mount, displays code, auto-navigates to room. JoinRoomPage has form with validation, calls joinRoom, navigates on success. All pages retrieve session/displayName/avatar and redirect if missing. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Create protected RoomPage and configure React Router</name>
  <files>src/pages/RoomPage.tsx, src/App.tsx, src/main.tsx</files>
  <action>
**File 1: src/pages/RoomPage.tsx**

Create protected room page with loader pattern from RESEARCH.md Pattern 3:

1. **Loader function (export as roomLoader):**
   - Import LoaderFunctionArgs from react-router
   - Get session using `supabase.auth.getSession()`
   - If no session, redirect to '/?error=no-session'
   - Query participants table: `.select('*, rooms(*)').eq('room_id', params.roomId).eq('user_id', session.user.id).single()`
   - If no participant found, redirect to '/?error=not-participant'
   - Return { participant }

2. **Component:**
   - Use useLoaderData from react-router to get participant
   - Show participant's display name and avatar
   - Show room code from participant.rooms.code
   - Show "is_storyteller" badge if participant.is_storyteller
   - Placeholder text: "Room interface coming in Phase 3"

3. **UI structure:**
   - Container size="md"
   - Stack gap="md"
   - Title showing room code
   - Text showing user's display name + avatar
   - Badge "Storyteller" or "Player" based on is_storyteller

4. **Imports:**
   - Container, Stack, Title, Text, Badge from @mantine/core
   - LoaderFunctionArgs, useLoaderData, redirect from react-router
   - supabase from @/lib/supabase

**File 2: src/App.tsx**

Configure React Router following Pattern 3:

1. **Remove existing content** - replace with router setup
2. **Create routes array:**
   - { path: '/', element: <HomePage /> }
   - { path: '/setup', element: <SessionSetupPage /> }
   - { path: '/create', element: <CreateRoomPage /> }
   - { path: '/join', element: <JoinRoomPage /> }
   - { path: '/room/:roomId', element: <RoomPage />, loader: roomLoader }
3. **Create router:** `const router = createBrowserRouter(routes)`
4. **Return:** `<RouterProvider router={router} />`
5. **Imports:**
   - createBrowserRouter, RouterProvider from react-router
   - All page components
   - roomLoader from ./pages/RoomPage

**File 3: src/main.tsx**

Update to wrap with MantineProvider and NotificationsProvider:

1. **Check if NotificationsProvider already imported** - add if missing
2. **Wrap structure:**
   ```tsx
   <MantineProvider theme={theme} defaultColorScheme="dark">
     <Notifications />
     <App />
   </MantineProvider>
   ```
3. **Imports:**
   - Notifications from @mantine/notifications
   - Import '@mantine/notifications/styles.css' (add to CSS imports)

DO NOT use BrowserRouter component - use createBrowserRouter + RouterProvider for loader support. DO NOT check session in component useEffect - use loader pattern to prevent FOUC.
  </action>
  <verify>
npx tsc --noEmit
grep -n "roomLoader.*LoaderFunctionArgs\|getSession.*redirect" src/pages/RoomPage.tsx
grep -n "createBrowserRouter\|RouterProvider\|room/:roomId.*loader" src/App.tsx
grep -n "Notifications\|@mantine/notifications/styles" src/main.tsx
  </verify>
  <done>
RoomPage has loader function checking session and participant, redirects if invalid. App.tsx uses createBrowserRouter with routes including protected /room/:roomId with loader. main.tsx wraps app with NotificationsProvider. TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npx tsc --noEmit`
2. AvatarSelector component uses Grid layout with emoji buttons
3. SessionSetupPage uses Mantine form validation with hasLength and isNotEmpty
4. CreateRoomPage calls createRoom and displays code, auto-navigates
5. JoinRoomPage validates 4-letter code pattern and calls joinRoom
6. RoomPage loader checks session + participant before rendering
7. App.tsx uses createBrowserRouter with loader on protected route
8. All pages follow gothic theme (dark background, crimson accents)
9. Notifications provider added to main.tsx
</verification>

<success_criteria>
- [ ] AvatarSelector renders 12 emoji in responsive grid
- [ ] SessionSetupPage validates name (2-20 chars) and avatar (required)
- [ ] HomePage has create/join navigation buttons
- [ ] CreateRoomPage creates room, shows code, auto-navigates
- [ ] JoinRoomPage validates 4-letter uppercase code
- [ ] RoomPage loader redirects if no session or not participant
- [ ] Router configuration uses loaders for protected routes
- [ ] Gothic theme applied to all pages
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-session-a-room-entry/02-02-SUMMARY.md` using the standard summary template.
</output>

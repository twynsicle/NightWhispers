---
phase: 04-core-messaging
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useMessages.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Players receive broadcast messages from Storyteller in PlayerChatView"
    - "Storyteller broadcast appears in all player conversations simultaneously"
    - "1-to-1 messages still work (not broken by fix)"
  artifacts:
    - path: "src/hooks/useMessages.ts"
      provides: "Fixed message filtering logic"
      min_lines: 140
      contains: "OR pattern for broadcast + 1-to-1"
  key_links:
    - from: "useMessages database query (lines 51-60)"
      to: "messages table"
      via: "OR filter: (1-to-1) OR (broadcast)"
      pattern: "\\.or\\(.*is_broadcast"
    - from: "useMessages Broadcast subscription (lines 91-94)"
      to: "room channel"
      via: "isRelevant check includes is_broadcast"
      pattern: "newMessage\\.is_broadcast"
---

<objective>
Fix broadcast message filtering bug in useMessages hook so players receive broadcasts.

Purpose: PlayerChatView currently filters OUT broadcast messages due to XOR logic in conversation filtering. This breaks MSG-04 requirement (Storyteller can broadcast to all players). The fix changes from exclusive OR to inclusive OR pattern.

Output: Players see both 1-to-1 messages with Storyteller AND broadcast messages in their chat view.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-core-messaging/04-VERIFICATION.md
@.planning/phases/04-core-messaging/04-01-SUMMARY.md
@.planning/phases/04-core-messaging/04-02-SUMMARY.md
@src/hooks/useMessages.ts
</context>

<tasks>

<task type="auto">
  <name>Fix broadcast message filtering in useMessages hook</name>
  <files>src/hooks/useMessages.ts</files>
  <action>
Modify the useMessages hook to use OR pattern instead of XOR for message filtering.

**Lines 51-60 (database query):**

Current XOR logic:
- If recipientId: load ONLY 1-to-1 messages (excludes broadcasts)
- If null: load ONLY broadcast messages

New OR logic:
- If recipientId: load 1-to-1 messages OR broadcasts
- If null: load broadcasts only (no change needed)

Implementation:
```typescript
// Replace lines 51-60 with:
if (recipientId) {
  // 1-to-1 conversation: messages between participantId and recipientId OR broadcasts
  query = query.or(
    `and(sender_id.eq.${participantId},recipient_id.eq.${recipientId}),` +
      `and(sender_id.eq.${recipientId},recipient_id.eq.${participantId}),` +
      `is_broadcast.eq.true`
  )
} else {
  // Broadcast messages only (is_broadcast = true)
  query = query.eq('is_broadcast', true)
}
```

**Lines 91-94 (Broadcast subscription filter):**

Current XOR logic:
- If recipientId: accept ONLY sender/recipient match (excludes broadcasts)
- If null: accept ONLY is_broadcast

New OR logic:
- If recipientId: accept sender/recipient match OR is_broadcast
- If null: accept is_broadcast only (no change needed)

Implementation:
```typescript
// Replace lines 91-94 with:
const isRelevant = recipientId
  ? (newMessage.recipient_id === recipientId ||
     newMessage.sender_id === recipientId ||
     newMessage.is_broadcast)
  : newMessage.is_broadcast
```

**Why this fixes MSG-04:**
- PlayerChatView calls useMessages with recipientId = storytellerId
- Old logic: filters to ONLY messages where sender=player OR sender=storyteller (1-to-1 only)
- New logic: includes 1-to-1 messages PLUS all broadcasts (is_broadcast=true)
- Broadcast messages have recipient_id=null and is_broadcast=true, so they now pass the filter

**Critical:** This is an OR operation, not AND. The message is relevant if ANY condition is true (1-to-1 match OR broadcast), not ALL conditions.
  </action>
  <verify>
Run TypeScript compilation check:
```bash
npx tsc --noEmit
```

Verify new logic with grep:
```bash
grep -A5 "if (recipientId)" src/hooks/useMessages.ts
```

Expected: OR clause includes "is_broadcast.eq.true" in database query
Expected: isRelevant check includes "|| newMessage.is_broadcast" in subscription filter
  </verify>
  <done>
- Database query includes "is_broadcast.eq.true" in OR clause when recipientId is set
- Broadcast subscription filter checks "newMessage.is_broadcast" in addition to sender/recipient match
- TypeScript compiles without errors
- 1-to-1 messages still filtered correctly (existing logic unchanged, just extended)
  </done>
</task>

</tasks>

<verification>
After fix is applied, manually test:

1. **Broadcast delivery to players:**
   - Storyteller sends broadcast "Night begins"
   - All players see broadcast in PlayerChatView
   - Broadcast appears with ðŸ“¢ badge

2. **1-to-1 messages still work:**
   - Storyteller sends 1-to-1 to Player A
   - Player A sees message
   - Player B does NOT see message (isolation preserved)

3. **Mixed conversation:**
   - Storyteller sends 1-to-1 "You are the Demon" to Player A
   - Storyteller sends broadcast "Everyone close your eyes"
   - Player A sees BOTH messages in conversation
   - Player B sees ONLY broadcast

4. **Message persistence:**
   - Send broadcast and 1-to-1 messages
   - Refresh browser
   - Verify both message types reload correctly
</verification>

<success_criteria>
- MSG-04 verified: Storyteller broadcast appears in all player chat views
- MSG-01 still works: 1-to-1 messages appear only for intended recipient
- No regressions: Broadcast-only view (recipientId=null) unchanged
- TypeScript compilation passes
- VERIFICATION.md gap closed (broadcast filtering bug resolved)
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-messaging/04-04-SUMMARY.md` documenting:
- Bug description (XOR vs OR pattern)
- Fix implementation (database query + subscription filter)
- Testing results (broadcast delivery confirmed)
- MSG-04 requirement verified
</output>
